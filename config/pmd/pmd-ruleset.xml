<?xml version="1.0"?>
<ruleset name="Hexagonal Architecture - Law of Demeter"
         xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0
         https://pmd.sourceforge.io/ruleset_2_0_0.xsd">

    <description>
        Law of Demeter enforcement for Hexagonal Architecture (PMD 7.x Compatible)

        데미터의 법칙 (Law of Demeter):
        - 객체는 자기 자신, 파라미터, 생성한 객체, 인스턴스 변수만 접근
        - Train wreck (a.getB().getC()) 금지
        - Tell, Don't Ask 원칙 준수

        @author Sangwon Ryu (ryu@company.com)
        @since 2025-01-10
        @updated 2025-12 - PMD 7.x XPath 마이그레이션
    </description>

    <!-- ========================================
         데미터의 법칙 (Law of Demeter)
         ======================================== -->

    <rule ref="category/java/design.xml/LawOfDemeter">
        <priority>1</priority>
        <properties>
            <!-- Domain 레이어는 모든 체이닝 금지 -->
            <property name="violationSuppressRegex" value=""/>

            <!-- Fluent API 패턴 허용 (Builder, Stream) -->
            <property name="trustRadius" value="2"/>
        </properties>
    </rule>

    <!-- ========================================
         추가 설계 규칙
         ======================================== -->

    <!-- Getter 남용 방지 (PMD 7.x 호환) -->
    <rule ref="category/java/design.xml/DataClass">
        <priority>2</priority>
        <properties>
            <!-- 허용 대상:
                 - DTO, Request, Response, Command, Query (CQRS 패턴)
                 - *Properties (Spring @ConfigurationProperties)
                 - *Config (설정 클래스)
                 - Q* (QueryDSL 자동 생성 클래스)
                 - ApiPaths 내부 클래스 (상수 홀더)
                 - Record 타입
                 - Interface
            -->
            <property name="violationSuppressXPath"
                      value="//ClassDeclaration[
                             @Interface = true()
                             or contains(@SimpleName, 'DTO')
                             or contains(@SimpleName, 'Request')
                             or contains(@SimpleName, 'Response')
                             or contains(@SimpleName, 'Command')
                             or contains(@SimpleName, 'Query')
                             or contains(@SimpleName, 'Properties')
                             or contains(@SimpleName, 'Config')
                             or starts-with(@SimpleName, 'Q')
                             or ancestor::ClassDeclaration[contains(@SimpleName, 'ApiPaths')]
                             ] | //RecordDeclaration"/>
        </properties>
    </rule>

    <!-- 과도한 임포트 (결합도 높음) -->
    <rule ref="category/java/design.xml/ExcessiveImports">
        <priority>3</priority>
        <properties>
            <property name="minimum" value="30"/>
        </properties>
    </rule>

    <!-- 깊은 중첩 방지 -->
    <rule ref="category/java/design.xml/AvoidDeeplyNestedIfStmts">
        <priority>2</priority>
        <properties>
            <property name="problemDepth" value="3"/>
        </properties>
    </rule>

    <!-- God Class 방지 (LCOM 기반) -->
    <rule ref="category/java/design.xml/GodClass">
        <priority>2</priority>
    </rule>

    <!-- ========================================
         단일 책임 원칙 (Single Responsibility Principle)
         PMD 7.x XPath 규칙 - PackageDeclaration 기반 필터링
         ======================================== -->

    <!-- Domain Layer: 가장 엄격 (≤ 7 public methods) -->
    <rule name="DomainTooManyMethods"
          language="java"
          message="Domain class has too many public methods (max 7) - violates SRP"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
<![CDATA[
//ClassDeclaration[
    ancestor::CompilationUnit/PackageDeclaration[contains(@Name, '.domain.')]
    and @Interface = false()
    and not(contains(@SimpleName, 'Exception'))
    and count(.//MethodDeclaration[@Visibility = 'public']) > 7
]
]]>
                </value>
            </property>
        </properties>
        <description>
            Domain 클래스는 최대 7개의 public 메서드만 가져야 합니다.
            더 많은 메서드가 필요하면 클래스를 분리하세요.
        </description>
    </rule>

    <!-- Application Layer: UseCase는 작아야 함 (≤ 5 public methods) -->
    <rule name="UseCaseTooManyMethods"
          language="java"
          message="UseCase has too many public methods (max 5) - one UseCase = one responsibility"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
<![CDATA[
//ClassDeclaration[
    ancestor::CompilationUnit/PackageDeclaration[contains(@Name, '.application.')]
    and (contains(@SimpleName, 'UseCase') or contains(@SimpleName, 'Service'))
    and count(.//MethodDeclaration[@Visibility = 'public']) > 5
]
]]>
                </value>
            </property>
        </properties>
        <description>
            하나의 UseCase는 하나의 책임만 가져야 합니다.
            복잡한 UseCase는 여러 개로 분리하세요.
        </description>
    </rule>

    <!-- Controller: 너무 많은 엔드포인트 (≤ 10 endpoints) -->
    <rule ref="category/java/design.xml/TooManyMethods">
        <priority>2</priority>
        <properties>
            <property name="maxmethods" value="10"/>
            <!-- adapter.in 패키지만 적용, ExceptionHandler는 예외 (PMD 7.x 호환) -->
            <property name="violationSuppressXPath"
                      value="//ClassDeclaration[
                             not(ancestor::CompilationUnit/PackageDeclaration[contains(@Name, '.adapter.in.')])
                             or contains(@SimpleName, 'ExceptionHandler')
                             ]"/>
        </properties>
    </rule>

    <!-- 과도한 필드 (≤ 7 fields) -->
    <rule ref="category/java/design.xml/TooManyFields">
        <priority>2</priority>
        <properties>
            <property name="maxfields" value="7"/>
            <!-- 설정 클래스는 필드가 많을 수 있음 (Redis, DB 등 인프라 설정) -->
            <property name="violationSuppressXPath"
                      value="//ClassDeclaration[
                             contains(@SimpleName, 'Config')
                             or contains(@SimpleName, 'Properties')
                             or starts-with(@SimpleName, 'Q')
                             ]"/>
        </properties>
    </rule>

    <!-- 레이어별 클래스 길이 제한 (PMD 7.x 호환) -->
    <rule name="DomainExcessiveClassLength"
          language="java"
          message="Domain class too long (max 200 lines) - split into smaller classes"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
<![CDATA[
//ClassDeclaration[
    ancestor::CompilationUnit/PackageDeclaration[contains(@Name, '.domain.')]
    and (@EndLine - @BeginLine) > 200
]
]]>
                </value>
            </property>
        </properties>
    </rule>

    <rule name="ApplicationExcessiveClassLength"
          language="java"
          message="Application class too long (max 150 lines) - split into smaller UseCases"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>2</priority>
        <properties>
            <property name="xpath">
                <value>
<![CDATA[
//ClassDeclaration[
    ancestor::CompilationUnit/PackageDeclaration[contains(@Name, '.application.')]
    and (@EndLine - @BeginLine) > 150
]
]]>
                </value>
            </property>
        </properties>
    </rule>

    <!-- 일반 클래스 길이 제한 (PMD 7.x - ExcessiveClassLength deprecated 대체) -->
    <rule name="GeneralExcessiveClassLength"
          language="java"
          message="Class too long (max 300 lines) - consider splitting into smaller classes"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>3</priority>
        <properties>
            <property name="xpath">
                <value>
<![CDATA[
//ClassDeclaration[
    (@EndLine - @BeginLine) > 300
    and not(ancestor::CompilationUnit/PackageDeclaration[contains(@Name, '.domain.')])
    and not(ancestor::CompilationUnit/PackageDeclaration[contains(@Name, '.application.')])
]
]]>
                </value>
            </property>
        </properties>
        <description>
            PMD 7.x에서 ExcessiveClassLength가 deprecated되어 커스텀 XPath 규칙으로 대체.
            일반 클래스는 300줄을 초과하면 분리를 고려하세요.
        </description>
    </rule>

    <!-- ========================================
         레이어별 커스텀 규칙 (PMD 7.x 호환)
         ======================================== -->

    <!-- Domain Layer: 데미터 법칙 엄격 적용 (PMD 7.x 호환) -->
    <rule name="DomainLayerDemeterStrict"
          message="Domain layer must strictly follow Law of Demeter - no long method chains (LoD)"
          language="java"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
<![CDATA[
//ClassDeclaration[ancestor::CompilationUnit/PackageDeclaration[contains(@Name, '.domain.')]]
    //MethodCall[
        MethodCall
        and not(ancestor::Annotation)
        and not(@MethodName = ('builder', 'toBuilder', 'build'))
        and not(@MethodName = ('stream', 'map', 'flatMap', 'filter', 'distinct', 'sorted', 'collect', 'reduce', 'peek', 'limit', 'skip', 'forEach', 'findFirst', 'findAny', 'anyMatch', 'allMatch', 'noneMatch', 'count', 'toList'))
        and not(@MethodName = ('orElse', 'orElseGet', 'orElseThrow', 'ifPresent', 'ifPresentOrElse', 'isPresent', 'isEmpty', 'get'))
        and not(@MethodName = ('add', 'subtract', 'multiply', 'divide', 'compareTo', 'setScale', 'abs', 'negate', 'pow'))
        and not(@MethodName = ('append', 'toString'))
    ]
]]>
                </value>
            </property>
        </properties>
        <description>
            Domain 레이어에서는 메서드 체이닝을 최소화해야 합니다.
            허용: Builder 패턴, Stream API, Optional 체이닝, BigDecimal 연산, StringBuilder

            ❌ BAD:
            order.getCustomer().getAddress().getCity()

            ✅ GOOD:
            order.getShippingCity() // 도메인 메서드로 캡슐화
        </description>
    </rule>

    <!-- Controller 레이어: Repository 직접 의존 금지 (PMD 7.x 호환) -->
    <rule name="ControllerNoRepositoryDependency"
          language="java"
          message="Controller must not depend on Repository - use UseCase only"
          class="net.sourceforge.pmd.lang.rule.xpath.XPathRule">
        <priority>1</priority>
        <properties>
            <property name="xpath">
                <value>
<![CDATA[
//ClassDeclaration[ancestor::CompilationUnit/PackageDeclaration[contains(@Name, '.adapter.in.')]]
    //FieldDeclaration//ClassType[contains(@SimpleName, 'Repository')]
]]>
                </value>
            </property>
        </properties>
        <description>
            Controller는 Repository에 직접 의존하면 안 됩니다.
            UseCase를 통해서만 비즈니스 로직에 접근하세요.

            ❌ BAD:
            private final OrderRepository orderRepository;

            ✅ GOOD:
            private final CreateOrderUseCase createOrderUseCase;
        </description>
    </rule>

    <!-- ========================================
         허용 패턴 주석 (PMD 7.x에서는 규칙 내부에서 처리)
         ======================================== -->
    <!--
        PMD 7.x에서는 Builder 패턴, Stream API 등의 허용 패턴을
        각 규칙의 XPath 조건에서 직접 제외 처리합니다.

        허용되는 패턴:
        - Builder: .builder(), .toBuilder(), .build()
        - Stream: .stream(), .map(), .filter(), .collect() 등
        - Optional: .orElse(), .orElseThrow(), .ifPresent() 등
        - BigDecimal: .add(), .multiply(), .compareTo() 등
        - StringBuilder: .append(), .toString()
    -->

</ruleset>
