#!/bin/bash
# ========================================
# Pre-Commit Hook (Simplified)
# ========================================
# Runs ArchUnit tests + Gradle quality checks
# Replaces 13 validator scripts with unified approach
# ========================================

set -e  # Exit on first error

# ========================================
# Setup
# ========================================

# Resolve symlink for macOS/Linux compatibility
if [ -L "${BASH_SOURCE[0]}" ]; then
    HOOK_SCRIPT="$(readlink "${BASH_SOURCE[0]}")"
    if [[ "$HOOK_SCRIPT" != /* ]]; then
        SYMLINK_DIR=$(dirname "${BASH_SOURCE[0]}")
        TARGET_DIR=$(dirname "$HOOK_SCRIPT")
        REAL_TARGET_DIR=$(cd "$SYMLINK_DIR" && cd "$TARGET_DIR" && pwd)
        HOOK_SCRIPT="$REAL_TARGET_DIR/$(basename "$HOOK_SCRIPT")"
    fi
else
    HOOK_SCRIPT="${BASH_SOURCE[0]}"
fi

HOOKS_DIR="$(cd "$(dirname "$HOOK_SCRIPT")" && pwd)"
PROJECT_ROOT="$(cd "$HOOKS_DIR/.." && pwd)"

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

# ========================================
# Helper Functions
# ========================================

log_info() {
    echo -e "${BLUE}ℹ️  $1${NC}"
}

log_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

log_error() {
    echo -e "${RED}❌ $1${NC}"
}

# ========================================
# Check Staged Changes
# ========================================

log_info "Checking staged changes..."

CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$CHANGED_FILES" ]; then
    log_warning "No files staged for commit"
    exit 0
fi

# Count Java files
JAVA_FILES=$(echo "$CHANGED_FILES" | grep "\.java$" | wc -l | tr -d ' ')

if [ "$JAVA_FILES" -eq 0 ]; then
    log_info "No Java files changed, skipping validation"
    exit 0
fi

log_info "Found $JAVA_FILES Java file(s) changed"

# ========================================
# Run Spotless Auto-Format
# ========================================

echo ""
log_info "Running Spotless auto-format..."
cd "$PROJECT_ROOT"

if ./gradlew spotlessApply --quiet --no-daemon; then
    # Re-stage any files that were modified by Spotless
    git add -u
    log_success "Spotless formatting applied"
else
    log_error "Spotless formatting failed"
    echo ""
    echo "  Run './gradlew spotlessApply' to see detailed errors"
    exit 1
fi

# ========================================
# Run ArchUnit Tests
# ========================================

echo ""
log_info "Running ArchUnit architecture tests..."
cd "$PROJECT_ROOT"

VALIDATION_FAILED=0

# Run all ArchUnit tests (includes Zero-Tolerance rules)
if ./gradlew test --tests "*ArchitectureTest" --tests "*ConventionTest" --quiet --no-daemon; then
    log_success "ArchUnit tests passed"
else
    log_error "ArchUnit tests failed - architecture violations detected"
    echo ""
    echo "  ArchUnit tests enforce:"
    echo "  • Lombok prohibition (Domain, JPA Entity, Orchestration)"
    echo "  • Transaction boundaries (@Transactional rules)"
    echo "  • Spring proxy constraints (public/private/final)"
    echo "  • Long FK strategy (JPA relationship annotations)"
    echo "  • Orchestration pattern rules"
    echo "  • Layer dependency rules (Hexagonal Architecture)"
    echo ""
    echo "  Run './gradlew test' to see detailed violations"
    VALIDATION_FAILED=1
fi

# ========================================
# Run Gradle Quality Checks
# ========================================

echo ""
log_info "Running Gradle quality checks (Checkstyle, PMD, SpotBugs)..."

if ./gradlew check --quiet --no-daemon; then
    log_success "Gradle quality checks passed"
else
    log_error "Gradle quality checks failed"
    echo ""
    echo "  Quality tools detected issues:"
    echo "  • Checkstyle: Code style violations"
    echo "  • PMD: Code quality issues"
    echo "  • SpotBugs: Potential bugs"
    echo ""
    echo "  Run './gradlew check' to see detailed reports"
    VALIDATION_FAILED=1
fi

# ========================================
# Final Result
# ========================================

echo ""
echo "========================================"
if [ $VALIDATION_FAILED -eq 0 ]; then
    log_success "All validations passed! ✨"
    echo "========================================"
    echo ""
    echo "  ✅ ArchUnit architecture tests: PASSED"
    echo "  ✅ Gradle quality checks: PASSED"
    echo ""
    exit 0
else
    log_error "Validation failed - commit blocked"
    echo "========================================"
    echo ""
    echo "Fix the issues above and try again."
    echo "Or use 'git commit --no-verify' to skip (NOT RECOMMENDED)"
    echo ""
    exit 1
fi
