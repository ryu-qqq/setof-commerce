# ===============================================
# Spring Boot Web API Application Configuration
# ===============================================
# Spring Boot 3.5.x + Java 21 기준
# Bootstrap 모듈 - 실행 가능한 애플리케이션 설정
#
# 설정 분리 원칙:
# - application.yml: 공통 인프라 설정 (Server, Jackson, Actuator)
# - rest-api.yml: REST API 레이어 설정 (Security, OpenAPI)
# - persistence.yml: 영속성 레이어 설정 (DataSource, JPA, Flyway)
# - logback-spring.xml: 로깅 설정 (Profile별 JSON/패턴 분리)
#
# @since 1.0.0
# ===============================================

# ===============================================
# Server Configuration (Tomcat)
# ===============================================
server:
  port: 8080

  # Proxy 헤더 처리 (ngrok, 로드밸런서 등)
  # X-Forwarded-* 헤더를 신뢰하여 원본 URL 인식
  forward-headers-strategy: framework

  # Tomcat 서블릿 컨테이너 설정
  tomcat:
    # 스레드풀 설정
    threads:
      # 최소 스레드 수 (항상 살아있는 스레드)
      min-spare: 10
      # 최대 스레드 수 (동시 처리 가능한 최대 요청 수)
      # CPU 코어 수 * 2 ~ 4 권장
      max: 200

    # 커넥션 설정
    connection-timeout: 20s  # 커넥션 타임아웃 (읽기 대기 시간)
    keep-alive-timeout: 60s  # Keep-Alive 타임아웃

    # 큐 설정
    accept-count: 100  # 대기 큐 크기 (max threads 초과 시 대기)

    # 최대 커넥션 수
    max-connections: 8192  # NIO 커넥터 기본값

  # Graceful Shutdown (Spring Boot 2.3+)
  shutdown: graceful  # 진행 중인 요청 완료 후 종료

# ===============================================
# Spring Configuration
# ===============================================
spring:
  application:
    name: spring-standards-api

  # Profile 설정
  profiles:
    active: local  # local, dev, staging, prod

  # ===============================================
  # Config Import (각 모듈의 설정 파일 로드)
  # ===============================================
  config:
    import:
      - classpath:rest-api.yml
      - classpath:persistence.yml
      - classpath:redis.yml
      - classpath:portone.yml

  # ===============================================
  # MessageSource (i18n)
  # ===============================================
  messages:
    # 메시지 번들 베이스 이름 (messages_{locale}.properties 로딩)
    basename: messages
    # 한글 깨짐 방지: UTF-8 고정
    encoding: UTF-8
    # 서버 시스템 로케일에 의존하지 않음
    fallback-to-system-locale: false

  # ===============================================
  # Jackson (JSON 직렬화/역직렬화)
  # ===============================================
  jackson:
    # 날짜/시간 포맷 (ISO 8601)
    date-format: yyyy-MM-dd'T'HH:mm:ss
    time-zone: Asia/Seoul

    # Serialization 설정
    serialization:
      # ISO-8601 포맷 사용 (타임스탬프 숫자 대신)
      WRITE_DATES_AS_TIMESTAMPS: false
      # 빈 객체 직렬화 허용
      FAIL_ON_EMPTY_BEANS: false

    # Deserialization 설정
    deserialization:
      # 알 수 없는 필드 무시 (API 버전 호환성)
      FAIL_ON_UNKNOWN_PROPERTIES: false

    # Default Property Inclusion
    default-property-inclusion: non_null  # null 필드 제외

  # ===============================================
  # Web Configuration
  # ===============================================
  web:
    locale: ko_KR
    locale-resolver: fixed  # 고정 로케일

  # ===============================================
  # MVC Configuration
  # ===============================================
  mvc:
    # Content Negotiation
    contentnegotiation:
      favor-parameter: false
      favor-path-extension: false

    # PathPatternParser is the default matcher in Spring Framework 6.1+.
    # Deprecated matching-strategy property is removed (ant_path_matcher no longer supported).
    # DispatcherServlet now raises NoResourceFoundException for 404s by default,
    # so throw-exception-if-no-handler-found is no longer configurable.

# ===============================================
# Management & Actuator (모니터링)
# ===============================================
management:
  endpoints:
    web:
      exposure:
        # Actuator 엔드포인트 노출
        include: health,info,metrics,prometheus,loggers
      base-path: /actuator

  endpoint:
    health:
      show-details: when-authorized  # 인증된 사용자에게만 상세 정보 노출
    loggers:
      enabled: true  # 런타임 로그 레벨 변경 지원

  metrics:
    export:
      prometheus:
        enabled: true  # Prometheus 메트릭 노출 (ADOT Collector가 scrape)

    # ===============================================
    # Metrics Tags (ADOT/Prometheus 필수)
    # ===============================================
    # ADOT Sidecar가 scrape할 때 서비스 구분용
    # Amazon Managed Prometheus에서 쿼리 시 필수
    tags:
      application: ${spring.application.name}
      environment: ${spring.profiles.active:local}

    # 히스토그램 분포 설정 (percentiles)
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5,0.95,0.99
      slo:
        http.server.requests: 100ms,500ms,1s,5s

  # Health Indicator 설정
  health:
    db:
      enabled: true
    diskspace:
      enabled: true

# ===============================================
# Sentry Configuration (Error Tracking)
# ===============================================
sentry:
  dsn: ${SENTRY_DSN:https://93171c7ddb8ad90ef418b7aa0b2b0efc@o4510661281644544.ingest.us.sentry.io/4510678108012544}
  environment: ${spring.profiles.active:local}
  release: ${APP_VERSION:unknown}
  # TraceId 연동 (OpenTelemetry 연계)
  traces-sample-rate: 1.0
  # 성능 모니터링
  enable-tracing: true
  # 예외 필터링
  ignored-exceptions-for-type:
    - org.springframework.web.servlet.resource.NoResourceFoundException
    - org.springframework.security.access.AccessDeniedException

# ===============================================
# Profile-Specific Configurations
# ===============================================
---
# Local 환경
spring:
  config:
    activate:
      on-profile: local

server:
  tomcat:
    threads:
      max: 50  # 로컬에서는 스레드 수 제한

---
# Development 환경
spring:
  config:
    activate:
      on-profile: dev

server:
  tomcat:
    threads:
      max: 100

---
# Staging 환경
spring:
  config:
    activate:
      on-profile: staging

server:
  tomcat:
    threads:
      max: 150

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus

---
# Production 환경
spring:
  config:
    activate:
      on-profile: prod

server:
  tomcat:
    threads:
      max: 200

  # Graceful Shutdown Timeout
  lifecycle:
    timeout-per-shutdown-phase: 30s

management:
  endpoints:
    web:
      exposure:
        # 프로덕션: health, metrics, prometheus만 노출
        include: health,metrics,prometheus
