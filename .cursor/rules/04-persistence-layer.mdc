---
description: Persistence Layer ì½”ë”© ê·œì¹™ (Entity, Repository, Adapter, Mapper)
globs: ["**/persistence/**/*.java", "**/adapter/out/**/*.java"]
alwaysApply: false
---

# Persistence Layer Rules (18ê°œ ê·œì¹™)

Persistence LayerëŠ” Domain ê°ì²´ë¥¼ ì˜ì†í™”í•˜ê³  ì¡°íšŒí•˜ëŠ” ì—­í• ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤. Long FK ì „ëµê³¼ CQRS íŒ¨í„´ì„ ì ìš©í•©ë‹ˆë‹¤.

---

## í•µì‹¬ ì›ì¹™ (Zero-Tolerance)

| Code | Rule | Detection |
|------|------|-----------|
| ENT-002 | Long FK ì „ëµ (JPA ê´€ê³„ ê¸ˆì§€) | `@ManyToOne`, `@OneToMany` |
| EMAP-002 | EntityMapper Pure Java | `@Mapper`, `@Data`, `@Builder` |
| EMAP-003 | ì‹œê°„ í•„ë“œ ìƒì„± ê¸ˆì§€ | `Instant.now()`, `LocalDateTime.now()` |
| QADP-001 | QueryAdapterëŠ” ìœ„ì„ë§Œ | `JPAQueryFactory` ì§ì ‘ ì‚¬ìš© |
| QADP-002 | QueryAdapter @Transactional ê¸ˆì§€ | `@Transactional` |
| QADP-008 | QueryAdapter ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê¸ˆì§€ | if/switch ì¡°ê±´ ë¶„ê¸° |

---

## ì»´í¬ë„ŒíŠ¸ ì—­í•  ë¶„ë‹´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Persistence Layer                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Entity   â”‚JpaRepo   â”‚QueryDsl  â”‚ Mapper   â”‚ Adapter        â”‚
â”‚(ì˜ì†ê°ì²´)â”‚(Command) â”‚(Query)   â”‚(ë³€í™˜)    â”‚(ì¡°í•©)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Long FK  â”‚ save()   â”‚ findBy*  â”‚ Domain   â”‚ CommandAdapter â”‚
â”‚ BaseAuditâ”‚ delete() â”‚ count()  â”‚ â†”Entity  â”‚ QueryAdapter   â”‚
â”‚ Lombok âŒâ”‚          â”‚ exists() â”‚ Pure Javaâ”‚ @TransactionalâŒâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Entity (ENT-*)

### Long FK ì „ëµ (ENT-002) ğŸš¨ **Zero-Tolerance**

**JPA ê´€ê³„ ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.** Long íƒ€ì… FKë¡œ ì €ì¥í•©ë‹ˆë‹¤.

```java
// âŒ BAD - JPA ê´€ê³„ ì–´ë…¸í…Œì´ì…˜
@Entity
public class OrderJpaEntity {
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private UserJpaEntity user;  // N+1 ë¬¸ì œ ì›ì¸

    @OneToMany(mappedBy = "order")
    private List<OrderLineJpaEntity> orderLines;  // ê¸ˆì§€!
}

// âœ… GOOD - Long FK ì „ëµ
@Entity
@Table(name = "orders")
public class OrderJpaEntity extends SoftDeletableEntity {
    @Id
    private Long id;

    @Column(name = "user_id", nullable = false)
    private Long userId;  // Long FK

    @Column(name = "status", nullable = false)
    @Enumerated(EnumType.STRING)
    private OrderStatus status;

    @Column(name = "total_amount", nullable = false)
    private BigDecimal totalAmount;

    // Lombok ê¸ˆì§€ - ìˆ˜ë™ ìƒì„±ì/íŒ©í† ë¦¬
    protected OrderJpaEntity() { }  // JPAìš©

    public static OrderJpaEntity of(Long id, Long userId,
            OrderStatus status, BigDecimal totalAmount) {
        OrderJpaEntity entity = new OrderJpaEntity();
        entity.id = id;
        entity.userId = userId;
        entity.status = status;
        entity.totalAmount = totalAmount;
        return entity;
    }

    // ì ‘ê·¼ì ë©”ì„œë“œ
    public Long getId() { return id; }
    public Long getUserId() { return userId; }
    public OrderStatus getStatus() { return status; }
    public BigDecimal getTotalAmount() { return totalAmount; }
}
```

### ENT ê·œì¹™ ìƒì„¸

| Code | Rule | Severity |
|------|------|----------|
| ENT-001 | BaseAuditEntity/SoftDeletableEntity ìƒì† | CRITICAL |
| ENT-002 | Long FK ì „ëµ (ê´€ê³„ ì–´ë…¸í…Œì´ì…˜ ê¸ˆì§€) | BLOCKER |
| ENT-003 | Lombok ê¸ˆì§€ | BLOCKER |
| ENT-004 | of() static factory method | CRITICAL |
| ENT-005 | protected/private ìƒì„±ì | MAJOR |

### Base Entity ìƒì†
```java
// BaseAuditEntity - ìƒì„±/ìˆ˜ì • ì‹œê°„
@MappedSuperclass
@EntityListeners(AuditingEntityListener.class)
public abstract class BaseAuditEntity {
    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    private Instant createdAt;

    @LastModifiedDate
    @Column(name = "updated_at", nullable = false)
    private Instant updatedAt;
}

// SoftDeletableEntity - ì†Œí”„íŠ¸ ì‚­ì œ ì§€ì›
@MappedSuperclass
public abstract class SoftDeletableEntity extends BaseAuditEntity {
    @Column(name = "deleted", nullable = false)
    private boolean deleted = false;

    @Column(name = "deleted_at")
    private Instant deletedAt;

    public void markDeleted() {
        this.deleted = true;
        this.deletedAt = Instant.now();
    }
}
```

---

## Repository (REPO-*)

### JpaRepository (Command ì „ìš©)
```java
public interface OrderJpaRepository extends JpaRepository<OrderJpaEntity, Long> {
    // save(), delete() ê¸°ë³¸ ì œê³µ
    // ì»¤ìŠ¤í…€ Command ë©”ì„œë“œë§Œ ì¶”ê°€ (Query ê¸ˆì§€)
}
```

### QueryDslRepository (Query ì „ìš©)
```java
@Repository
public class OrderQueryDslRepository {

    private final JPAQueryFactory queryFactory;

    public OrderQueryDslRepository(JPAQueryFactory queryFactory) {
        this.queryFactory = queryFactory;
    }

    // 4ê°€ì§€ í‘œì¤€ ë©”ì„œë“œ
    public Optional<OrderJpaEntity> findById(Long id) {
        return Optional.ofNullable(
            queryFactory.selectFrom(order)
                .where(order.id.eq(id), order.deleted.isFalse())
                .fetchOne()
        );
    }

    public List<OrderJpaEntity> findByCriteria(SearchOrderCriteria criteria) {
        return queryFactory.selectFrom(order)
            .where(
                userIdEq(criteria.userId()),
                statusEq(criteria.status()),
                order.deleted.isFalse()
            )
            .offset(criteria.offset())
            .limit(criteria.limit())
            .fetch();
    }

    public boolean existsById(Long id) {
        return queryFactory.selectOne()
            .from(order)
            .where(order.id.eq(id), order.deleted.isFalse())
            .fetchFirst() != null;
    }

    public long countByCriteria(SearchOrderCriteria criteria) {
        return queryFactory.select(order.count())
            .from(order)
            .where(
                userIdEq(criteria.userId()),
                statusEq(criteria.status()),
                order.deleted.isFalse()
            )
            .fetchOne();
    }

    // BooleanExpression í—¬í¼
    private BooleanExpression userIdEq(Long userId) {
        return userId != null ? order.userId.eq(userId) : null;
    }

    private BooleanExpression statusEq(OrderStatus status) {
        return status != null ? order.status.eq(status) : null;
    }
}
```

### REPO ê·œì¹™ ìƒì„¸

| Code | Rule | Severity |
|------|------|----------|
| REPO-001 | JpaRepositoryëŠ” Commandë§Œ | CRITICAL |
| REPO-002 | QueryDslRepositoryëŠ” Queryë§Œ | CRITICAL |
| REPO-003 | Entity ì§ì ‘ ë°˜í™˜ ê¸ˆì§€ (Adapter í†µí•´) | MAJOR |
| REPO-004 | N+1 ë°©ì§€ (fetch join ë˜ëŠ” ë¶„ë¦¬ ì¿¼ë¦¬) | CRITICAL |

---

## EntityMapper (EMAP-*)

### Pure Java í•„ìˆ˜ (EMAP-002) ğŸš¨ **Zero-Tolerance**
```java
// âŒ BAD - MapStruct/Lombok ì‚¬ìš©
@Mapper
public interface OrderEntityMapper {
    OrderJpaEntity toEntity(Order order);
}

// âœ… GOOD - Pure Java
@Component
public class OrderJpaEntityMapper {

    // Domain â†’ Entity
    public OrderJpaEntity toEntity(Order order) {
        return OrderJpaEntity.of(
            order.id().value(),
            order.userId().value(),
            order.status(),
            order.totalAmount().value()
        );
    }

    // Entity â†’ Domain
    public Order toDomain(OrderJpaEntity entity) {
        return Order.reconstitute(
            new OrderId(entity.getId()),
            new UserId(entity.getUserId()),
            entity.getStatus(),
            new Money(entity.getTotalAmount())
        );
    }

    // ì»¬ë ‰ì…˜ ë³€í™˜
    public List<Order> toDomainList(List<OrderJpaEntity> entities) {
        return entities.stream()
            .map(this::toDomain)
            .toList();
    }
}
```

### ì‹œê°„ í•„ë“œ ìƒì„± ê¸ˆì§€ (EMAP-003) ğŸš¨ **Zero-Tolerance**
```java
// âŒ BAD - Mapperì—ì„œ ì‹œê°„ ìƒì„±
public OrderJpaEntity toEntity(Order order) {
    entity.setCreatedAt(Instant.now());  // ê¸ˆì§€!
    entity.setUpdatedAt(LocalDateTime.now());  // ê¸ˆì§€!
    return entity;
}

// âœ… GOOD - JPA Auditingìœ¼ë¡œ ì²˜ë¦¬
// @CreatedDate, @LastModifiedDate ìë™ ì„¤ì •
```

### EMAP ê·œì¹™ ìƒì„¸

| Code | Rule | Severity |
|------|------|----------|
| EMAP-001 | @Component ì‚¬ìš© | MAJOR |
| EMAP-002 | Pure Java (Lombok/MapStruct ê¸ˆì§€) | BLOCKER |
| EMAP-003 | ì‹œê°„ í•„ë“œ ìƒì„± ê¸ˆì§€ | BLOCKER |
| EMAP-004 | ì–‘ë°©í–¥ ë³€í™˜ (toEntity/toDomain) | CRITICAL |
| EMAP-005 | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê¸ˆì§€ | CRITICAL |
| EMAP-006 | ì»¬ë ‰ì…˜ ë³€í™˜ ì§€ì› | MAJOR |

---

## Adapter (CADP-*, QADP-*)

### CommandAdapter (CADP-*)
```java
@Component
public class OrderCommandAdapter implements OrderCommandPort {

    private final OrderJpaRepository repository;
    private final OrderJpaEntityMapper mapper;

    public OrderCommandAdapter(OrderJpaRepository repository,
                               OrderJpaEntityMapper mapper) {
        this.repository = repository;
        this.mapper = mapper;
    }

    // âŒ @Transactional ê¸ˆì§€ - Managerê°€ ë‹´ë‹¹

    @Override
    public Long persist(Order order) {
        OrderJpaEntity entity = mapper.toEntity(order);
        return repository.save(entity).getId();
    }

    @Override
    public void delete(OrderId orderId) {
        repository.findById(orderId.value())
            .ifPresent(entity -> {
                entity.markDeleted();
                repository.save(entity);
            });
    }
}
```

### QueryAdapter (QADP-*) ğŸš¨ **Zero-Tolerance**
```java
@Component
public class OrderQueryAdapter implements OrderQueryPort {

    private final OrderQueryDslRepository queryRepository;
    private final OrderJpaEntityMapper mapper;

    public OrderQueryAdapter(OrderQueryDslRepository queryRepository,
                             OrderJpaEntityMapper mapper) {
        this.queryRepository = queryRepository;
        this.mapper = mapper;
    }

    // âŒ @Transactional ê¸ˆì§€ (QADP-002)
    // âŒ JPAQueryFactory ì§ì ‘ ì‚¬ìš© ê¸ˆì§€ (QADP-001)
    // âŒ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê¸ˆì§€ (QADP-008)

    @Override
    public Optional<Order> findById(OrderId id) {
        return queryRepository.findById(id.value())
            .map(mapper::toDomain);
    }

    @Override
    public List<Order> findByCriteria(SearchOrderCriteria criteria) {
        return mapper.toDomainList(
            queryRepository.findByCriteria(criteria)
        );
    }

    @Override
    public boolean existsById(OrderId id) {
        return queryRepository.existsById(id.value());
    }

    @Override
    public long countByCriteria(SearchOrderCriteria criteria) {
        return queryRepository.countByCriteria(criteria);
    }

    @Override
    public Order getById(OrderId id) {
        return findById(id)
            .orElseThrow(() -> new OrderNotFoundException(id));
    }
}
```

### QADP ê·œì¹™ ìƒì„¸ (Zero-Tolerance ë‹¤ìˆ˜)

| Code | Rule | Severity |
|------|------|----------|
| QADP-001 | QueryDslRepository ìœ„ì„ë§Œ | BLOCKER |
| QADP-002 | @Transactional ê¸ˆì§€ | BLOCKER |
| QADP-003 | @Component ì‚¬ìš© | MAJOR |
| QADP-004 | 4ê°œ í‘œì¤€ ë©”ì„œë“œ (findBy/get/exists/count) | MAJOR |
| QADP-005 | Mapper ìœ„ì„ ë³€í™˜ | MAJOR |
| QADP-006 | Optional ë°˜í™˜ (findBy) | CRITICAL |
| QADP-007 | Exception throw (get) | CRITICAL |
| QADP-008 | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê¸ˆì§€ | BLOCKER |
| QADP-009 | ë‹¨ì¼ QueryDslRepository ì˜ì¡´ | MAJOR |

---

## Admin Query (íŠ¹ìˆ˜ ì¼€ì´ìŠ¤)

Admin ê¸°ëŠ¥ì—ì„œëŠ” Joinì´ í—ˆìš©ë©ë‹ˆë‹¤.

```java
@Repository
public class OrderAdminQueryDslRepository {

    // Admin ì „ìš© - Join í—ˆìš©, DTO Projection ì‚¬ìš©
    public List<OrderAdminDto> findWithUserInfo(SearchOrderCriteria criteria) {
        return queryFactory
            .select(new QOrderAdminDto(
                order.id,
                order.totalAmount,
                // User ì •ë³´ ì„œë¸Œì¿¼ë¦¬ (Join ëŒ€ì‹ )
                JPAExpressions.select(user.name)
                    .from(user)
                    .where(user.id.eq(order.userId))
            ))
            .from(order)
            .where(order.deleted.isFalse())
            .fetch();
    }
}
```

---

## Lock Repository (ë¶„ì‚° ë½)

```java
@Repository
public class OrderLockRepository {

    private final JPAQueryFactory queryFactory;

    // 6ê°œ Lock ë©”ì„œë“œ
    public Optional<OrderJpaEntity> findByIdWithPessimisticRead(Long id) {
        return Optional.ofNullable(
            queryFactory.selectFrom(order)
                .where(order.id.eq(id))
                .setLockMode(LockModeType.PESSIMISTIC_READ)
                .fetchOne()
        );
    }

    public Optional<OrderJpaEntity> findByIdWithPessimisticWrite(Long id) {
        return Optional.ofNullable(
            queryFactory.selectFrom(order)
                .where(order.id.eq(id))
                .setLockMode(LockModeType.PESSIMISTIC_WRITE)
                .fetchOne()
        );
    }

    // PESSIMISTIC_FORCE_INCREMENT ë“±...
}
```

---

## ì°¸ì¡° ë¬¸ì„œ
- ì „ì²´ ê·œì¹™: `.claude/knowledge/rules/persistence-rules.md` (18ê°œ)
- í´ë˜ìŠ¤ í…œí”Œë¦¿: `.claude/knowledge/templates/persistence-templates.md` (3ê°œ)
- GOOD/BAD ì˜ˆì œ: `.claude/knowledge/examples/persistence-examples.md` (8ê°œ)
