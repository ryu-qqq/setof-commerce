# yaml-language-server: $schema=https://coderabbit.ai/integrations/schema.v2.json

# CodeRabbit Configuration for Spring Standards Project
# This configuration enforces our Zero-Tolerance rules and project conventions
# Based on: docs/coding_convention/ (98 rules analyzed)

language: ko-KR
tone_instructions: "Be ASSERTIVE on Zero-Tolerance rules (Lombok, Law of Demeter, Long FK, Transaction Boundary). Be CHILL on style/formatting. Enforce TDD discipline: test:/feat:/struct: commits must match changes."

early_access: true
enable_free_tier: false

reviews:
  profile: assertive
  high_level_summary: true
  high_level_summary_placeholder: |
    ## ğŸ“Š Summary

    This PR implements...

    ### âœ… Compliance Status
    - Zero-Tolerance Rules: [Pass/Fail]
    - Architecture: [Pass/Fail]
    - Testing: [Pass/Fail]

  poem: false
  collapse_walkthrough: false

  auto_review:
    enabled: true
    auto_incremental_review: true
    ignore_title_keywords:
      - "WIP"
      - "Draft"
      - "DO NOT MERGE"
    drafts: false
    base_branches:
      - "main"
      - "develop"
    ignore_usernames:
      - "dependabot"
      - "renovate"

  # íŒŒì¼ í•„í„°ë§ (ë¹Œë“œ ì‚°ì¶œë¬¼ ì œì™¸)
  path_filters:
    - "!**/build/**"
    - "!**/target/**"
    - "!**/.gradle/**"
    - "!**/node_modules/**"
    - "!**/*.class"
    - "!**/*.jar"
    - "!**/*.war"

  # TDD + Tidy First ê²€ì¦ (ì „ì²´ PR ëŒ€ìƒ)
  commit_instructions: |
    **TDD + Tidy First Validation**:

    1. **Commit Prefix Validation**
       - âœ… test: - Red Phase (failing tests)
       - âœ… feat: - Green Phase (make it work)
       - âœ… struct: - Refactor Phase (structural changes, behavior unchanged)
       - âœ… fix: - Bug fixes
       - âœ… chore: - Build/config changes
       - âŒ Flag commits without proper prefix

    2. **Tidy First Compliance**
       - âŒ **CRITICAL**: Never allow Structural + Behavioral in same commit
       - Structural: rename, extract method, move code, remove duplication
       - Behavioral: new feature, logic change, algorithm improvement
       - Example violations:
         * "feat: Add validation + rename variables" âŒ
         * "struct: Extract method + add new feature" âŒ
       - Correct approach:
         * "struct: Rename variables" â†’ separate commit
         * "test: Add validation test" â†’ separate commit
         * "feat: Implement validation" â†’ separate commit

    3. **Commit Size Check**
       - âœ… Ideal: 1-3 files per commit
       - âš ï¸ Warning: 4-10 files (suggest splitting)
       - âŒ Too large: 10+ files (must split)

    4. **Test Coverage**
       - test: commits MUST include test files
       - feat: commits SHOULD reference test: commits
       - struct: commits MUST keep all tests passing

  # Layerë³„ ì»¤ìŠ¤í…€ ë¦¬ë·° ê·œì¹™
  path_instructions:
    # Domain Layer (Pure Java - ê°€ì¥ ì—„ê²©)
    - path: "domain/src/main/java/**/*.java"
      instructions: |
        ğŸš¨ **CRITICAL ZERO-TOLERANCE RULES** (Must enforce):

        1. **Lombok ì ˆëŒ€ ê¸ˆì§€**
           - âŒ @Data, @Builder, @Getter, @Setter, @Value, @With, @AllArgsConstructor, @NoArgsConstructor
           - âœ… Plain Java getters/setters only
           - **Reason**: Domainì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ í•µì‹¬, ëª…ì‹œì  ì½”ë“œ í•„ìˆ˜

        2. **Law of Demeter (Getter ì²´ì´ë‹ ê¸ˆì§€)**
           - âŒ order.getCustomer().getAddress().getZipCode()
           - âœ… order.getCustomerZipCode()
           - **Pattern**: Tell, Don't Ask ì›ì¹™ ì¤€ìˆ˜

        3. **No Setters on Aggregate Root**
           - âŒ public void setStatus(OrderStatus status)
           - âœ… public void cancel(CancelReason reason)
           - **Reason**: ìƒíƒœ ë³€ê²½ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œë¡œë§Œ

        4. **No External Dependencies**
           - âŒ JPA annotations (@Entity, @Table, @Column)
           - âŒ Spring annotations (@Component, @Service)
           - âœ… Pure Java only
           - **Reason**: Domainì€ ê¸°ìˆ  ë…ë¦½ì 

        5. **Immutability**
           - âœ… final fields where possible
           - âœ… Collections should be unmodifiable (Collections.unmodifiableList)
           - âœ… Value Objects are immutable

        6. **Static Factory Methods (3ì¢…)**
           - âœ… forNew(): ì‹ ê·œ ìƒì„± (Auto Increment, ID null)
           - âœ… of(): ID ê¸°ë°˜ ìƒì„± (ID null ì²´í¬ í•„ìˆ˜)
           - âœ… reconstitute(): ì˜ì†ì„± ë³µì› (Mapper ì „ìš©)
           - âŒ public ìƒì„±ì ê¸ˆì§€ (ìƒì„±ì private)

        7. **Foreign Key as Value Object**
           - âŒ private Long paymentId; (ì›ì‹œ íƒ€ì… ê¸ˆì§€)
           - âœ… private PaymentId paymentId; (VO ì‚¬ìš© í•„ìˆ˜)
           - **Pattern**: Law of Demeter ì¤€ìˆ˜ (getPaymentIdValue() ì œê³µ)

        8. **Clock Dependency**
           - âœ… Clock ì˜ì¡´ì„± ì£¼ì… (createdAt, updatedAt)
           - âŒ LocalDateTime.now() ì§ì ‘ í˜¸ì¶œ ê¸ˆì§€

        **Architecture Patterns**:
        - Aggregate Root pattern ì¤€ìˆ˜
        - Value Objects are immutable
        - Domain Events for side effects

    # Application Layer (UseCase + Transaction)
    - path: "application/src/main/java/**/*.java"
      instructions: |
        ğŸš¨ **CRITICAL ZERO-TOLERANCE RULES**:

        1. **Transaction Boundary Violation**
           - âŒ External API calls (RestTemplate, WebClient, Feign) inside @Transactional
           - âœ… Keep transactions SHORT and ISOLATED
           - **Reason**: ì™¸ë¶€ APIëŠ” ë¶ˆì•ˆì •, íŠ¸ëœì­ì…˜ì€ DB ì‘ì—…ë§Œ

        2. **Spring Proxy Constraints**
           - âŒ @Transactional on private methods
           - âŒ @Transactional on final methods
           - âŒ this.methodWithTransactional() (same-class call)
           - âœ… public methods only, called from other beans

        3. **CQRS Separation (ì ˆëŒ€ ë¶„ë¦¬)**
           - âŒ Command + Query in same UseCase
           - âœ… Command UseCase: port/in/command/
           - âœ… Query UseCase: port/in/query/
           - **Pattern**: íŒ¨í‚¤ì§€ë„ service/command/, service/query/ë¡œ ë¶„ë¦¬

        4. **DTO Package Separation**
           - âŒ UseCase ë‚´ë¶€ì— inner Record ì •ì˜
           - âœ… Command DTO: dto/command/
           - âœ… Query DTO: dto/query/
           - âœ… Response DTO: dto/response/

        5. **Single Responsibility**
           - Each UseCase handles ONE business operation
           - Compose multiple UseCases via Facade

        6. **Assembler Pattern**
           - âœ… DTO â†” Domain ë³€í™˜ì€ Assemblerì— ì§‘ì¤‘
           - âŒ Serviceì—ì„œ ì§ì ‘ ë³€í™˜ ë¡œì§ ì‘ì„± ê¸ˆì§€

        **Transaction Management**:
        - @Transactionalì€ UseCase(Service)ì—ë§Œ
        - FacadeëŠ” íŠ¸ëœì­ì…˜ ë°–ì—ì„œ ì¡°í•©
        - Transaction Manager: ë‹¨ì¼ Port íŠ¸ëœì­ì…˜ ì²˜ë¦¬

    # Persistence Layer (Adapter-out)
    - path: "adapter-out/persistence-**/src/main/java/**/*.java"
      instructions: |
        ğŸš¨ **CRITICAL RULES**:

        1. **Long FK Strategy (ì—„ê²©)**
           - âŒ @ManyToOne private Customer customer;
           - âŒ @OneToMany private List<OrderLineItem> items;
           - âœ… @Column private Long customerId;
           - **Reason**: JPA ê´€ê³„ëŠ” N+1, Lazy Loading ë¬¸ì œ ë°œìƒ

        2. **Entity Construction Pattern**
           - âŒ public ìƒì„±ì ë…¸ì¶œ
           - âœ… of() ìŠ¤íƒœí‹± ë©”ì„œë“œë§Œ public (Mapper ì „ìš©)
           - âœ… protected ê¸°ë³¸ ìƒì„±ì (JPA ìŠ¤í™, ë¹ˆ ìƒíƒœ ìœ ì§€)
           - âœ… ì „ì²´ í•„ë“œ ìƒì„±ì private (ë¬´ë¶„ë³„í•œ ìƒì„± ë°©ì§€)

        3. **BaseAuditEntity / SoftDeletableEntity í™œìš©**
           - âœ… ì‹œê°„ ì •ë³´ í•„ìš” ì‹œ â†’ BaseAuditEntity ìƒì†
           - âœ… ì†Œí”„íŠ¸ ì‚­ì œ í•„ìš” ì‹œ â†’ SoftDeletableEntity ìƒì†
           - âœ… ë¶ˆí•„ìš” ì‹œ â†’ ìƒì† ì•ˆ í•¨

        4. **Entity Immutability**
           - âŒ Setter ì œê³µ ê¸ˆì§€
           - âœ… Getterë§Œ ì œê³µ
           - âœ… Entities should be immutable after construction

        5. **CQRS Separation**
           - âœ… Command Adapter: JpaRepository ì‚¬ìš© (saveë§Œ)
           - âœ… Query Adapter: QueryDSL ì‚¬ìš© (ì¡°íšŒë§Œ)
           - âŒ JPA + QueryDSL í˜¼í•© êµ¬í˜„ ê¸ˆì§€

        6. **Transactionì€ Application Layer ì „ìš©**
           - âŒ @Transactional on Repository/Adapter/Entity
           - âœ… Transactionì€ UseCaseì—ì„œë§Œ

        **QueryDSL Optimization**:
        - Use fetchJoin() for collections
        - Check query execution plans
        - Avoid N+1 problems

    # REST API Layer (Adapter-in)
    - path: "adapter-in/rest-api/src/main/java/**/*.java"
      instructions: |
        ğŸš¨ **CRITICAL RULES**:

        1. **Thin Controller**
           - âŒ No business logic in controllers
           - âœ… Only request/response transformation
           - **Pattern**: HTTP â†’ Mapper â†’ UseCase â†’ Mapper â†’ HTTP

        2. **ResponseEntity<ApiResponse<T>> ë˜í•‘ í•„ìˆ˜**
           - âŒ ResponseEntity<T> ê¸ˆì§€
           - âŒ ApiResponse<T> ê¸ˆì§€
           - âœ… ResponseEntity<ApiResponse<T>> í•„ìˆ˜

        3. **@Valid ê²€ì¦ í•„ìˆ˜**
           - âœ… ëª¨ë“  Request DTOì— @Valid
           - âœ… PathVariable, RequestParamì— @Positive, @Max ë“±

        4. **DELETE ë©”ì„œë“œ ê¸ˆì§€**
           - âŒ @DeleteMapping ê¸ˆì§€
           - âœ… ì†Œí”„íŠ¸ ì‚­ì œëŠ” PATCHë¡œ ì²˜ë¦¬

        5. **Exception Handling**
           - âŒ Controllerì—ì„œ try-catch ê¸ˆì§€
           - âœ… GlobalExceptionHandler ìœ„ì„

        6. **Mapper DI**
           - âœ… @Component DI (ìƒì„±ì ì£¼ì…)
           - âŒ Static ë©”ì„œë“œ ê¸ˆì§€

        7. **DTO Pattern**
           - âœ… Java 21 Record ì‚¬ìš©
           - âŒ Lombok ê¸ˆì§€
           - âœ… Command: *ApiRequest (POST, PUT, PATCH, DELETE)
           - âœ… Query: *ApiRequest (GET)
           - âœ… Response: *ApiResponse

        **RESTful URI**:
        - ë¦¬ì†ŒìŠ¤ ë³µìˆ˜í˜• ì‚¬ìš© (/orders)
        - ë™ì‚¬ ê¸ˆì§€ (/createOrder âŒ)
        - ìƒíƒœ ë³€ê²½ì€ PATCH (/orders/{id}/cancel)

    # Test Code
    - path: "**/src/test/java/**/*.java"
      instructions: |
        **Test Requirements**:

        1. **Test Coverage**
           - Domain layer: 90%+ required
           - Application layer: 80%+ required

        2. **Test Patterns**
           - Use Test Fixtures for complex objects
           - Given-When-Then structure
           - Descriptive test names (@DisplayName)

        3. **Test Fixtures**
           - Layerë³„ ë…ë¦½ì ì¸ Fixture ëª¨ë“ˆ
           - Pure Java (Lombok ê¸ˆì§€)
           - Reusable test data

        4. **ArchUnit**
           - Verify layer dependencies
           - Verify naming conventions
           - Verify Zero-Tolerance rules

        5. **Integration Tests**
           - Use Testcontainers for DB
           - Clean up test data
           - Test tags strategy (@Tag)

  # ë„êµ¬ í™œì„±í™” (Java/Spring ì „ìš©)
  tools:
    # Java ì •ì  ë¶„ì„
    pmd:
      enabled: true

    # ë³´ì•ˆ ìŠ¤ìº”
    gitleaks:
      enabled: true

    # Dependency ì·¨ì•½ì 
    trivy:
      enabled: true

    # Dockerfile ê²€ì¦
    hadolint:
      enabled: true

    # YAML ê²€ì¦
    yamllint:
      enabled: true

chat:
  auto_reply: true
  art: false

knowledge_base:
  opt_out: false

  # í”„ë¡œì íŠ¸ ì»¨ë²¤ì…˜ íŒŒì¼ ìë™ í•™ìŠµ
  code_guidelines:
    enabled: true
    filePatterns:
      - "**/.claude/CLAUDE.md"
      - "**/docs/coding_convention/**/*.md"
      - "**/CODING_STANDARDS.md"
      - "**/.cursorrules"
      - "**/.claude/scripts/README-langfuse-trace.md"

  learnings:
    scope: "organization"

  # ì™¸ë¶€ ì§€ì‹ í†µí•© (ì„ íƒ)
  web_search:
    enabled: true

  # TDD ë©”íŠ¸ë¦­ ì¶”ì  (ì°¸ê³ )
  # - LangFuse Dashboard: https://us.cloud.langfuse.com
  # - ìë™ ìˆ˜ì§‘: TDD Phase, ì»¤ë°‹ í¬ê¸°, Tidy First ì¤€ìˆ˜ìœ¨
  # - JSONL ë¡œê·¸: ~/.claude/logs/tdd-cycle.jsonl

code_generation:
  docstrings:
    language: ko-KR
  unit_tests:
    language: ko-KR
