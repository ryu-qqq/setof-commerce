# AWS Distro for OpenTelemetry (ADOT) Collector Configuration
# Service: setof-commerce-web-api-admin (port 8081)
# Updated for ADOT v0.45.1

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  prometheus:
    config:
      global:
        scrape_interval: 30s
        scrape_timeout: 10s

      scrape_configs:
        - job_name: 'application-metrics'
          scrape_interval: 30s
          static_configs:
            - targets: ['localhost:8081']
          metrics_path: /actuator/prometheus
          metric_relabel_configs:
            - source_labels: [__name__]
              regex: '(http_.*|jvm_.*|process_.*|system_.*|application_.*|business_.*|spring_.*)'
              action: keep

        # REMOVED: otel-collector self-scrape job
        # This was causing "out of order sample" errors in AMP when multiple
        # ECS tasks send metrics with identical service_instance_id=localhost:8888

  awsecscontainermetrics:
    collection_interval: 30s

processors:
  batch:
    timeout: 60s
    send_batch_size: 1000

  memory_limiter:
    check_interval: 5s
    limit_mib: 410
    spike_limit_mib: 128

  resource:
    attributes:
      - key: environment
        value: prod
        action: upsert
      - key: cluster_name
        value: setof-commerce-cluster-prod
        action: upsert
      - key: service_name
        value: web-api-admin
        action: upsert

  metricstransform:
    transforms:
      - include: .*
        match_type: regexp
        action: update
        operations:
          - action: add_label
            new_label: platform
            new_value: ecs

exporters:
  awsxray:
    region: ${AWS_REGION}
    indexed_attributes:
      - http.method
      - http.status_code
      - http.route
      - rpc.service
      - rpc.method
      - db.system
      - db.name

  prometheusremotewrite:
    endpoint: ${AMP_ENDPOINT}
    auth:
      authenticator: sigv4auth
    resource_to_telemetry_conversion:
      enabled: true
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

extensions:
  sigv4auth:
    region: ${AWS_REGION}
    service: aps

  health_check:
    endpoint: :13133

service:
  extensions:
    - sigv4auth
    - health_check

  telemetry:
    logs:
      level: warn
      encoding: json
    metrics:
      level: detailed

  pipelines:
    metrics:
      receivers:
        - otlp
        - prometheus
        - awsecscontainermetrics
      processors:
        - memory_limiter
        - resource
        - metricstransform
        - batch
      exporters:
        - prometheusremotewrite

    traces:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - resource
        - batch
      exporters:
        - awsxray
