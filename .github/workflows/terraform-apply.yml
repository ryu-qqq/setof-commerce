name: Terraform Apply

on:
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©
  workflow_call:      # ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥
    inputs:
      web-api-image-tag:
        description: 'Web API Docker image tag (e.g., web-api-1-abc1234)'
        required: false
        type: string
      web-api-admin-image-tag:
        description: 'Web API Admin Docker image tag (e.g., web-api-admin-1-abc1234)'
        required: false
        type: string
      legacy-api-image-tag:
        description: 'Legacy API Docker image tag (e.g., legacy-api-1-abc1234)'
        required: false
        type: string
      legacy-api-admin-image-tag:
        description: 'Legacy API Admin Docker image tag (e.g., legacy-api-admin-1-abc1234)'
        required: false
        type: string
      migration-image-tag:
        description: 'Migration service Docker image tag (e.g., migration-1-abc1234)'
        required: false
        type: string
      legacy-batch-image-tag:
        description: 'Legacy Batch Docker image tag (e.g., legacy-batch-1-abc1234)'
        required: false
        type: string
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  contents: read
  id-token: write

jobs:
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      # ìˆœì°¨ ì‹¤í–‰ìœ¼ë¡œ ë³€ê²½ (ì˜ì¡´ì„± ê³ ë ¤)
      max-parallel: 1
      matrix:
        module:
          # ì˜ì¡´ì„± ìˆœì„œëŒ€ë¡œ ë°°ì¹˜
          - name: ecr
            dir: terraform/ecr
            order: 0
          - name: ecs-cluster
            dir: terraform/ecs-cluster
            order: 1
          - name: elasticache
            dir: terraform/elasticache
            order: 2
          - name: ecs-web-api
            dir: terraform/ecs-web-api
            order: 3
          - name: ecs-web-api-admin
            dir: terraform/ecs-web-api-admin
            order: 4
          - name: ecs-web-api-legacy
            dir: terraform/ecs-web-api-legacy
            order: 5
          - name: ecs-web-api-legacy-admin
            dir: terraform/ecs-web-api-legacy-admin
            order: 6
          - name: ecs-migration
            dir: terraform/ecs-migration
            order: 7
          - name: ecs-batch
            dir: terraform/ecs-batch
            order: 8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2
          role-duration-seconds: 3600
          role-session-name: GitHubActions-SetOfCommerce-TerraformApply

      - name: Terraform Init - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: terraform init -reconfigure

      - name: Check and Import Existing Resources - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "ðŸ” ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ í™•ì¸ ë° Import ì¤‘..."

          # ECR ëª¨ë“ˆ: í•­ìƒ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ import ì‹œë„ (apply ì‹œ RepositoryAlreadyExistsException ë°©ì§€)
          if [ "${{ matrix.module.name }}" == "ecr" ]; then
            echo "ðŸ§¹ OLD ECR Repository state ì •ë¦¬ ì¤‘..."
            # OLD repo (setof-commerce-legacy-admin-prod - "-api-" ì—†ëŠ” ì´ì „ ë²„ì „)ê°€ stateì— ìžˆìœ¼ë©´ ì œê±°
            # ì´ repoëŠ” ë” ì´ìƒ Terraformìœ¼ë¡œ ê´€ë¦¬í•˜ì§€ ì•ŠìŒ
            OLD_ECR_RESOURCES=$(terraform state list 2>/dev/null | grep -E 'ecr.*legacy.*admin' | grep -v 'api' || true)
            if [ -n "$OLD_ECR_RESOURCES" ]; then
              echo "  âš ï¸  OLD ECR resources found in state, removing to prevent force_delete..."
              for resource in $OLD_ECR_RESOURCES; do
                echo "  â†’ Removing from state: $resource"
                terraform state rm "$resource" || echo "  âš ï¸  Failed to remove $resource"
              done
            fi

            echo "ðŸ“¦ ECR Repository ë¦¬ì†ŒìŠ¤ Import ì¤‘..."
            if aws ecr describe-repositories --repository-names setof-commerce-web-api-prod --region ap-northeast-2 >/dev/null 2>&1; then
              echo "  â†’ Importing setof-commerce-web-api-prod ECR repository..."
              terraform import -input=false 'module.ecr_web_api.aws_ecr_repository.this[0]' setof-commerce-web-api-prod || echo "  âš ï¸  Import failed or already in state"
            fi
            if aws ecr describe-repositories --repository-names setof-commerce-web-api-admin-prod --region ap-northeast-2 >/dev/null 2>&1; then
              echo "  â†’ Importing setof-commerce-web-api-admin-prod ECR repository..."
              terraform import -input=false 'module.ecr_web_api_admin.aws_ecr_repository.this[0]' setof-commerce-web-api-admin-prod || echo "  âš ï¸  Import failed or already in state"
            fi
            if aws ecr describe-repositories --repository-names setof-commerce-legacy-api-prod --region ap-northeast-2 >/dev/null 2>&1; then
              echo "  â†’ Importing setof-commerce-legacy-api-prod ECR repository..."
              terraform import -input=false 'module.ecr_legacy_api.aws_ecr_repository.this[0]' setof-commerce-legacy-api-prod || echo "  âš ï¸  Import failed or already in state"
            fi
            if aws ecr describe-repositories --repository-names setof-commerce-legacy-api-admin-prod --region ap-northeast-2 >/dev/null 2>&1; then
              echo "  â†’ Importing setof-commerce-legacy-api-admin-prod ECR repository..."
              terraform import -input=false 'module.ecr_legacy_api_admin.aws_ecr_repository.this[0]' setof-commerce-legacy-api-admin-prod || echo "  âš ï¸  Import failed or already in state"
            fi
            if aws ecr describe-repositories --repository-names setof-commerce-migration-prod --region ap-northeast-2 >/dev/null 2>&1; then
              echo "  â†’ Importing setof-commerce-migration-prod ECR repository..."
              terraform import -input=false 'module.ecr_migration.aws_ecr_repository.this[0]' setof-commerce-migration-prod || echo "  âš ï¸  Import failed or already in state"
            fi
            if aws ecr describe-repositories --repository-names setof-commerce-legacy-batch-prod --region ap-northeast-2 >/dev/null 2>&1; then
              echo "  â†’ Importing setof-commerce-legacy-batch-prod ECR repository..."
              terraform import -input=false 'module.ecr_legacy_batch.aws_ecr_repository.this[0]' setof-commerce-legacy-batch-prod || echo "  âš ï¸  Import failed or already in state"
            fi
          fi

          # Plan ì‹¤í–‰í•˜ì—¬ ì¶©ëŒ í™•ì¸
          set +e
          terraform plan -out=tfplan 2>&1 | tee plan_output.txt
          PLAN_EXIT_CODE=$?
          set -e

          # 409 ì—ëŸ¬ ë˜ëŠ” "already exists" íŒ¨í„´ í™•ì¸ (ECR ì™¸ ë‹¤ë¥¸ ëª¨ë“ˆìš©)
          if grep -q "EntityAlreadyExists\|already exists" plan_output.txt; then
            echo "âš ï¸  ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ë°œê²¬! Import ìž‘ì—… ì‹œìž‘..."

            # ECS Cluster ëª¨ë“ˆ
            if [ "${{ matrix.module.name }}" == "ecs-cluster" ]; then
              echo "ðŸ“¦ ECS Cluster ë¦¬ì†ŒìŠ¤ Import ì¤‘..."
              CLUSTER_ARN=$(aws ecs describe-clusters --clusters setof-commerce-cluster-prod --region ap-northeast-2 --query 'clusters[0].clusterArn' --output text 2>/dev/null || echo "")
              if [ -n "$CLUSTER_ARN" ] && [ "$CLUSTER_ARN" != "None" ]; then
                echo "  â†’ Importing ECS Cluster: $CLUSTER_ARN"
                terraform import -input=false aws_ecs_cluster.main "$CLUSTER_ARN" || echo "  âš ï¸  Import failed or already in state"
              fi
            fi

            # ElastiCache ëª¨ë“ˆ
            if [ "${{ matrix.module.name }}" == "elasticache" ]; then
              echo "ðŸ“¦ ElastiCache Redis ë¦¬ì†ŒìŠ¤ Import ì¤‘..."
              if aws elasticache describe-cache-clusters --cache-cluster-id setof-commerce-redis-prod --region ap-northeast-2 >/dev/null 2>&1; then
                echo "  â†’ Importing setof-commerce-redis-prod..."
                terraform import -input=false 'module.redis.aws_elasticache_cluster.this[0]' setof-commerce-redis-prod || echo "  âš ï¸  Import failed or already in state"
              fi
            fi

            # ECS Web API ëª¨ë“ˆ - Service Discovery Only (No ALB)
            # ALB resources removed - Strangler Fig Pattern
            # This service is accessed via: web-api.connectly.local:8080
            if [ "${{ matrix.module.name }}" == "ecs-web-api" ]; then
              echo "â„¹ï¸  ECS Web API uses Service Discovery only (no ALB to import)"
            fi

            # ECS Web API Admin ëª¨ë“ˆ
            if [ "${{ matrix.module.name }}" == "ecs-web-api-admin" ]; then
              echo "ðŸ“¦ ECS Web API Admin ë¦¬ì†ŒìŠ¤ Import ì¤‘..."

              # ALB
              ALB_ARN=$(aws elbv2 describe-load-balancers --names setof-commerce-admin-alb-prod --region ap-northeast-2 --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null || echo "")
              if [ -n "$ALB_ARN" ] && [ "$ALB_ARN" != "None" ]; then
                echo "  â†’ Importing ALB: $ALB_ARN"
                terraform import -input=false aws_lb.web_api_admin "$ALB_ARN" || echo "  âš ï¸  Import failed or already in state"
              fi

              # Target Group
              TG_ARN=$(aws elbv2 describe-target-groups --names setof-commerce-admin-tg-prod --region ap-northeast-2 --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || echo "")
              if [ -n "$TG_ARN" ] && [ "$TG_ARN" != "None" ]; then
                echo "  â†’ Importing Target Group: $TG_ARN"
                terraform import -input=false aws_lb_target_group.web_api_admin "$TG_ARN" || echo "  âš ï¸  Import failed or already in state"
              fi
            fi

            # ECS Web API Legacy ëª¨ë“ˆ (Strangler Fig Pattern)
            if [ "${{ matrix.module.name }}" == "ecs-web-api-legacy" ]; then
              echo "ðŸ“¦ ECS Legacy API ë¦¬ì†ŒìŠ¤ Import ì¤‘..."

              # ALB
              ALB_ARN=$(aws elbv2 describe-load-balancers --names setof-commerce-legacy-alb-prod --region ap-northeast-2 --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null || echo "")
              if [ -n "$ALB_ARN" ] && [ "$ALB_ARN" != "None" ]; then
                echo "  â†’ Importing ALB: $ALB_ARN"
                terraform import -input=false aws_lb.legacy_api "$ALB_ARN" || echo "  âš ï¸  Import failed or already in state"
              fi

              # Target Group
              TG_ARN=$(aws elbv2 describe-target-groups --names setof-commerce-legacy-tg-prod --region ap-northeast-2 --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || echo "")
              if [ -n "$TG_ARN" ] && [ "$TG_ARN" != "None" ]; then
                echo "  â†’ Importing Target Group: $TG_ARN"
                terraform import -input=false aws_lb_target_group.legacy_api "$TG_ARN" || echo "  âš ï¸  Import failed or already in state"
              fi
            fi

            # ECS Web API Legacy Admin ëª¨ë“ˆ (Partner Admin Server)
            if [ "${{ matrix.module.name }}" == "ecs-web-api-legacy-admin" ]; then
              echo "ðŸ“¦ ECS Legacy Admin API ë¦¬ì†ŒìŠ¤ Import ì¤‘..."

              # ALB
              ALB_ARN=$(aws elbv2 describe-load-balancers --names setof-commerce-legacy-admin-alb-prod --region ap-northeast-2 --query 'LoadBalancers[0].LoadBalancerArn' --output text 2>/dev/null || echo "")
              if [ -n "$ALB_ARN" ] && [ "$ALB_ARN" != "None" ]; then
                echo "  â†’ Importing ALB: $ALB_ARN"
                terraform import -input=false aws_lb.legacy_admin_api "$ALB_ARN" || echo "  âš ï¸  Import failed or already in state"
              fi

              # Target Group
              TG_ARN=$(aws elbv2 describe-target-groups --names setof-commerce-legacy-admin-tg-prod --region ap-northeast-2 --query 'TargetGroups[0].TargetGroupArn' --output text 2>/dev/null || echo "")
              if [ -n "$TG_ARN" ] && [ "$TG_ARN" != "None" ]; then
                echo "  â†’ Importing Target Group: $TG_ARN"
                terraform import -input=false aws_lb_target_group.legacy_admin_api "$TG_ARN" || echo "  âš ï¸  Import failed or already in state"
              fi
            fi

            # ECS Migration ëª¨ë“ˆ (Data Migration & Batch Scheduler)
            if [ "${{ matrix.module.name }}" == "ecs-migration" ]; then
              echo "â„¹ï¸  ECS Migration uses Service Discovery only (no ALB to import)"
            fi

            # ECS Batch ëª¨ë“ˆ (Legacy Batch Jobs - RunTask ì „ìš©)
            if [ "${{ matrix.module.name }}" == "ecs-batch" ]; then
              echo "â„¹ï¸  ECS Batch uses RunTask only (no ECS Service to import)"
              echo "â„¹ï¸  EventBridge Schedules and IAM roles will be created fresh"
            fi

            echo "âœ… Import ì™„ë£Œ! Plan ìž¬ì‹¤í–‰..."
            terraform plan -out=tfplan
          else
            echo "âœ… ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì—†ìŒ ë˜ëŠ” Stateì™€ ì¼ì¹˜. ì •ìƒ ì§„í–‰."
          fi

          rm -f plan_output.txt

      - name: Terraform Apply - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "ðŸš€ Applying Terraform for ${{ matrix.module.name }}..."

          # Image Tag ë³€ìˆ˜ ì„¤ì • (Build & Deploy ì›Œí¬í”Œë¡œìš°ì—ì„œ ì „ë‹¬ë¨)
          EXTRA_VARS=""

          if [ "${{ matrix.module.name }}" == "ecs-web-api" ] && [ -n "${{ inputs.web-api-image-tag }}" ]; then
            echo "ðŸ“¦ Using Web API image tag: ${{ inputs.web-api-image-tag }}"
            EXTRA_VARS="-var=image_tag=${{ inputs.web-api-image-tag }}"
          elif [ "${{ matrix.module.name }}" == "ecs-web-api-admin" ] && [ -n "${{ inputs.web-api-admin-image-tag }}" ]; then
            echo "ðŸ“¦ Using Web API Admin image tag: ${{ inputs.web-api-admin-image-tag }}"
            EXTRA_VARS="-var=image_tag=${{ inputs.web-api-admin-image-tag }}"
          elif [ "${{ matrix.module.name }}" == "ecs-web-api-legacy" ] && [ -n "${{ inputs.legacy-api-image-tag }}" ]; then
            echo "ðŸ“¦ Using Legacy API image tag: ${{ inputs.legacy-api-image-tag }}"
            EXTRA_VARS="-var=image_tag=${{ inputs.legacy-api-image-tag }}"
          elif [ "${{ matrix.module.name }}" == "ecs-web-api-legacy-admin" ] && [ -n "${{ inputs.legacy-api-admin-image-tag }}" ]; then
            echo "ðŸ“¦ Using Legacy Admin API image tag: ${{ inputs.legacy-api-admin-image-tag }}"
            EXTRA_VARS="-var=image_tag=${{ inputs.legacy-api-admin-image-tag }}"
          elif [ "${{ matrix.module.name }}" == "ecs-migration" ] && [ -n "${{ inputs.migration-image-tag }}" ]; then
            echo "ðŸ“¦ Using Migration image tag: ${{ inputs.migration-image-tag }}"
            EXTRA_VARS="-var=image_tag=${{ inputs.migration-image-tag }}"
          elif [ "${{ matrix.module.name }}" == "ecs-batch" ] && [ -n "${{ inputs.legacy-batch-image-tag }}" ]; then
            echo "ðŸ“¦ Using Legacy Batch image tag: ${{ inputs.legacy-batch-image-tag }}"
            EXTRA_VARS="-var=image_tag=${{ inputs.legacy-batch-image-tag }}"
          else
            echo "â„¹ï¸  No image tag provided for ${{ matrix.module.name }}, using default from provider.tf"
          fi

          # Terraform Plan with optional image_tag variable
          echo "ðŸ“‹ Generating fresh terraform plan..."
          terraform plan $EXTRA_VARS -out=tfplan

          terraform apply -auto-approve -no-color tfplan
          echo "âœ… Apply completed for ${{ matrix.module.name }}"

      - name: Terraform Output - ${{ matrix.module.name }}
        working-directory: ${{ matrix.module.dir }}
        run: |
          echo "ðŸ“‹ Outputs for ${{ matrix.module.name }}:"
          terraform output -json > outputs-${{ matrix.module.name }}.json
          terraform output

      - name: Upload Apply Results - ${{ matrix.module.name }}
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apply-results-${{ matrix.module.name }}
          path: ${{ matrix.module.dir }}/outputs-${{ matrix.module.name }}.json
          retention-days: 30

  notify-completion:
    name: Notify Deployment Completion
    needs: terraform-apply
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Create Deployment Summary
        run: |
          echo "## ðŸŽ‰ SetOf Commerce Infrastructure Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ needs.terraform-apply.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Modules Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECR Repository" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Cluster" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ElastiCache (Redis)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Web API (desired_count: 0)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Web API Admin (desired_count: 0)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Legacy API (Strangler Fig)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Legacy Admin API (Partner Admin)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Migration (Data Sync & Batch)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ECS Batch (Legacy Batch Jobs - RunTask only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URLs**:" >> $GITHUB_STEP_SUMMARY
          echo "- Web API: https://commerce.set-of.com (inactive)" >> $GITHUB_STEP_SUMMARY
          echo "- Admin API: https://admin.set-of.com (inactive)" >> $GITHUB_STEP_SUMMARY
          echo "- Legacy API: https://server.set-of.com" >> $GITHUB_STEP_SUMMARY
          echo "- Legacy Admin API: https://partner.set-of.com" >> $GITHUB_STEP_SUMMARY
          echo "- Migration: Internal service (no public endpoint)" >> $GITHUB_STEP_SUMMARY
          echo "- Batch: EventBridge scheduled (no public endpoint)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps**:" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify infrastructure in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "2. Check CloudWatch logs" >> $GITHUB_STEP_SUMMARY
          echo "3. Test application endpoints" >> $GITHUB_STEP_SUMMARY
