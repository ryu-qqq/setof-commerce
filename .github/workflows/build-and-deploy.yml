# ============================================================================
# SetOf Commerce Build & Deploy
#
# ê°œì„  ì‚¬í•­:
# 1. ë³€ê²½ ê°ì§€ ê¸°ë°˜ ì„ íƒì  ë¹Œë“œ (path filter)
# 2. í…ŒìŠ¤íŠ¸ í•„ìˆ˜í™” (continue-on-error ì œê±°)
# 3. Spring Context ë¡œë“œ ê²€ì¦
# ============================================================================

name: Build and Deploy to ECS

on:
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©
    inputs:
      force-all:
        description: 'ëª¨ë“  ì„œë¹„ìŠ¤ ê°•ì œ ë¹Œë“œ/ë°°í¬'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths-ignore:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
      - '**.md'
      - 'docs/**'

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: setof-commerce-cluster-prod

jobs:
  # ============================================================================
  # ë³€ê²½ ê°ì§€ (Path Filter)
  # - ê³µìœ  ëª¨ë“ˆ ë³€ê²½ ì‹œ ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ
  # - ê°œë³„ ì„œë¹„ìŠ¤ ë³€ê²½ ì‹œ í•´ë‹¹ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œ
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web-api: ${{ steps.filter.outputs.web-api }}
      web-api-admin: ${{ steps.filter.outputs.web-api-admin }}
      legacy-api: ${{ steps.filter.outputs.legacy-api }}
      legacy-api-admin: ${{ steps.filter.outputs.legacy-api-admin }}
      migration: ${{ steps.filter.outputs.migration }}
      legacy-batch: ${{ steps.filter.outputs.legacy-batch }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            shared:
              - 'domain/**'
              - 'core/**'
              - 'adapter-in/**'
              - 'adapter-out/**'
              - 'port-in/**'
              - 'port-out/**'
              - 'support/**'
              - 'gradle/**'
              - 'build.gradle'
              - 'settings.gradle'
              - 'libs.versions.toml'
            web-api:
              - 'bootstrap/bootstrap-web-api/**'
            web-api-admin:
              - 'bootstrap/bootstrap-web-api-admin/**'
            legacy-api:
              - 'bootstrap/bootstrap-legacy-web-api/**'
            legacy-api-admin:
              - 'bootstrap/bootstrap-legacy-web-api-admin/**'
            migration:
              - 'bootstrap/bootstrap-migration/**'
            legacy-batch:
              - 'bootstrap/bootstrap-batch/**'

      - name: Summary
        run: |
          echo "### ğŸ” Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Shared Modules | ${{ steps.filter.outputs.shared }} |" >> $GITHUB_STEP_SUMMARY
          echo "| web-api | ${{ steps.filter.outputs.web-api }} |" >> $GITHUB_STEP_SUMMARY
          echo "| web-api-admin | ${{ steps.filter.outputs.web-api-admin }} |" >> $GITHUB_STEP_SUMMARY
          echo "| legacy-api | ${{ steps.filter.outputs.legacy-api }} |" >> $GITHUB_STEP_SUMMARY
          echo "| legacy-api-admin | ${{ steps.filter.outputs.legacy-api-admin }} |" >> $GITHUB_STEP_SUMMARY
          echo "| migration | ${{ steps.filter.outputs.migration }} |" >> $GITHUB_STEP_SUMMARY
          echo "| legacy-batch | ${{ steps.filter.outputs.legacy-batch }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # í…ŒìŠ¤íŠ¸ (í•„ìˆ˜ - ì‹¤íŒ¨ ì‹œ ë¹Œë“œ ì¤‘ë‹¨)
  # ============================================================================
  test:
    name: Run Tests
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # shared ë˜ëŠ” ê°œë³„ ì„œë¹„ìŠ¤ ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
    if: |
      needs.detect-changes.outputs.shared == 'true' ||
      needs.detect-changes.outputs.web-api == 'true' ||
      needs.detect-changes.outputs.web-api-admin == 'true' ||
      needs.detect-changes.outputs.legacy-api == 'true' ||
      needs.detect-changes.outputs.legacy-api-admin == 'true' ||
      needs.detect-changes.outputs.migration == 'true' ||
      needs.detect-changes.outputs.legacy-batch == 'true' ||
      github.event.inputs.force-all == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Run tests
        run: |
          chmod +x gradlew
          ./gradlew clean test -x jacocoTestCoverageVerification --no-daemon
        # í…ŒìŠ¤íŠ¸ í•„ìˆ˜í™” - ì‹¤íŒ¨ ì‹œ ë¹Œë“œ ì¤‘ë‹¨

      - name: Test Summary
        if: always()
        run: |
          echo "### ğŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "*/build/test-results" ]; then
            echo "Test reports generated" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # ë¹Œë“œ Jobs (ì¡°ê±´ë¶€ ì‹¤í–‰)
  # ============================================================================
  build-web-api:
    name: Build web-api
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.web-api == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-web-api-prod
      component: web-api
      dockerfile: bootstrap/bootstrap-web-api/Dockerfile
      gradle-task: ":bootstrap:bootstrap-web-api:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-web-api-admin:
    name: Build web-api-admin
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.web-api-admin == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-web-api-admin-prod
      component: web-api-admin
      dockerfile: bootstrap/bootstrap-web-api-admin/Dockerfile
      gradle-task: ":bootstrap:bootstrap-web-api-admin:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-legacy-api:
    name: Build legacy-api
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.legacy-api == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-legacy-api-prod
      component: legacy-api
      dockerfile: bootstrap/bootstrap-legacy-web-api/Dockerfile
      gradle-task: ":bootstrap:bootstrap-legacy-web-api:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-legacy-api-admin:
    name: Build legacy-api-admin
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.legacy-api-admin == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-legacy-api-admin-prod
      component: legacy-api-admin
      dockerfile: bootstrap/bootstrap-legacy-web-api-admin/Dockerfile
      gradle-task: ":bootstrap:bootstrap-legacy-web-api-admin:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-migration:
    name: Build migration
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.migration == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-migration-prod
      component: migration
      dockerfile: bootstrap/bootstrap-migration/Dockerfile
      gradle-task: ":bootstrap:bootstrap-migration:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-legacy-batch:
    name: Build legacy-batch
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.legacy-batch == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-legacy-batch-prod
      component: legacy-batch
      dockerfile: bootstrap/bootstrap-batch/Dockerfile
      gradle-task: ":bootstrap:bootstrap-batch:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # ë°°í¬ Jobs (ë¹Œë“œ ì„±ê³µ ì‹œì—ë§Œ)
  # ============================================================================
  deploy-web-api:
    name: Deploy web-api
    needs: build-web-api
    if: needs.build-web-api.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-web-api-prod
      image-uri: ${{ needs.build-web-api.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-web-api-admin:
    name: Deploy web-api-admin
    needs: build-web-api-admin
    if: needs.build-web-api-admin.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-web-api-admin-prod
      image-uri: ${{ needs.build-web-api-admin.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-legacy-api:
    name: Deploy legacy-api
    needs: build-legacy-api
    if: needs.build-legacy-api.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-legacy-api-prod
      image-uri: ${{ needs.build-legacy-api.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-legacy-api-admin:
    name: Deploy legacy-api-admin
    needs: build-legacy-api-admin
    if: needs.build-legacy-api-admin.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      # FIXME: AWS ì„œë¹„ìŠ¤ëª…ê³¼ ì¼ì¹˜ (legacy-admin-prod, not legacy-api-admin-prod)
      ecs-service: setof-commerce-legacy-admin-prod
      image-uri: ${{ needs.build-legacy-api-admin.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # FIXME: migration ECS ì„œë¹„ìŠ¤ ìƒì„± í›„ í™œì„±í™” í•„ìš” (Secrets Manager ì„¤ì • í•„ìš”)
  # deploy-migration:
  #   name: Deploy migration
  #   needs: build-migration
  #   if: needs.build-migration.result == 'success'
  #   uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
  #   with:
  #     ecs-cluster: setof-commerce-cluster-prod
  #     ecs-service: setof-commerce-migration-prod
  #     image-uri: ${{ needs.build-migration.outputs.image-uri }}
  #   secrets:
  #     AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # NOTE: legacy-batchëŠ” ECS Serviceê°€ ì—†ìŒ (RunTask ì „ìš©)
  # Task Definitionì€ Terraformì´ ê´€ë¦¬í•˜ë¯€ë¡œ ë³„ë„ ë°°í¬ job ë¶ˆí•„ìš”
  # EventBridge ìŠ¤ì¼€ì¤„ì´ ìë™ìœ¼ë¡œ ìµœì‹  Task Definition ì‚¬ìš©

  # ============================================================================
  # Terraform Image Tag ì—…ë°ì´íŠ¸ (ìë™í™”)
  # - ë¹Œë“œ ì„±ê³µí•œ ì„œë¹„ìŠ¤ë§Œ íƒœê·¸ ì—…ë°ì´íŠ¸
  # ============================================================================
  update-terraform-tags:
    name: Update Terraform Image Tags
    needs: [build-web-api, build-web-api-admin, build-legacy-api, build-legacy-api-admin, build-migration, build-legacy-batch]
    if: |
      always() &&
      (needs.build-web-api.result == 'success' ||
       needs.build-web-api-admin.result == 'success' ||
       needs.build-legacy-api.result == 'success' ||
       needs.build-legacy-api-admin.result == 'success' ||
       needs.build-migration.result == 'success' ||
       needs.build-legacy-batch.result == 'success')
    uses: ./.github/workflows/terraform-apply.yml
    with:
      web-api-image-tag: ${{ needs.build-web-api.outputs.image-tag || '' }}
      web-api-admin-image-tag: ${{ needs.build-web-api-admin.outputs.image-tag || '' }}
      legacy-api-image-tag: ${{ needs.build-legacy-api.outputs.image-tag || '' }}
      legacy-api-admin-image-tag: ${{ needs.build-legacy-api-admin.outputs.image-tag || '' }}
      migration-image-tag: ${{ needs.build-migration.outputs.image-tag || '' }}
      legacy-batch-image-tag: ${{ needs.build-legacy-batch.outputs.image-tag || '' }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼ (Slack + GitHub Summary)
  # ============================================================================
  notify:
    name: Deployment Notification
    needs: [detect-changes, test, deploy-web-api, deploy-web-api-admin, deploy-legacy-api, deploy-legacy-api-admin, update-terraform-tags]
    if: always()
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-notify-slack.yml@main
    with:
      project-name: SetOf Commerce
      environment: prod
      status: |
        ${{
          (needs.test.result == 'failure') && 'failure' ||
          (needs.deploy-web-api.result == 'success' || needs.deploy-web-api.result == 'skipped') &&
          (needs.deploy-web-api-admin.result == 'success' || needs.deploy-web-api-admin.result == 'skipped') &&
          (needs.deploy-legacy-api.result == 'success' || needs.deploy-legacy-api.result == 'skipped') &&
          (needs.deploy-legacy-api-admin.result == 'success' || needs.deploy-legacy-api-admin.result == 'skipped') &&
          'success' || 'failure'
        }}
      components: |
        [
          {"name": "test", "status": "${{ needs.test.result }}"},
          {"name": "web-api", "status": "${{ needs.deploy-web-api.result }}"},
          {"name": "web-api-admin", "status": "${{ needs.deploy-web-api-admin.result }}"},
          {"name": "legacy-api", "status": "${{ needs.deploy-legacy-api.result }}"},
          {"name": "legacy-api-admin", "status": "${{ needs.deploy-legacy-api-admin.result }}"},
          {"name": "terraform-tags", "status": "${{ needs.update-terraform-tags.result }}"}
        ]
      mention-on-failure: "@here"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
