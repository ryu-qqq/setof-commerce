# ============================================================================
# SetOf Commerce Build & Deploy (Production)
#
# 3-Tier Pipeline: Stage Í≤ÄÏ¶ù ‚Üí ÏàòÎèô ÏäπÏù∏ ‚Üí Prod Î∞∞Ìè¨
#
# Î∞∞Ìè¨ ÎåÄÏÉÅ:
# - legacy-api (bootstrap-legacy-web-api)
# - legacy-api-admin (bootstrap-legacy-web-api-admin)
# - legacy-batch (bootstrap-batch)
# - web-api (bootstrap-web-api)
# - web-api-admin (bootstrap-web-api-admin)
# - migration (bootstrap-migration) - RunTask Ï†ÑÏö©
#
# Î∞∞Ìè¨ ÌîÑÎ°úÏÑ∏Ïä§:
# 1. Î≥ÄÍ≤Ω Í∞êÏßÄ Î∞è ÌÖåÏä§Ìä∏
# 2. Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
# 3. Stage ÌôòÍ≤Ω Ìó¨Ïä§Ï≤¥ÌÅ¨ (ÏÑ†ÌÉùÏ†Å Ïä§ÌÇµ Í∞ÄÎä•)
# 4. Production ÏäπÏù∏ Í≤åÏù¥Ìä∏ (GitHub Environment Protection)
# 5. ECS Î∞∞Ìè¨ Î∞è Terraform ÏóÖÎç∞Ïù¥Ìä∏
# ============================================================================

name: Build and Deploy to ECS (Production)

on:
  workflow_dispatch:
    inputs:
      force-all:
        description: 'Î™®Îì† ÏÑúÎπÑÏä§ Í∞ïÏ†ú ÎπåÎìú/Î∞∞Ìè¨'
        required: false
        default: false
        type: boolean
      skip-stage-check:
        description: 'Í∏¥Í∏â Î∞∞Ìè¨: Stage Ìó¨Ïä§Ï≤¥ÌÅ¨ Ïä§ÌÇµ'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    paths-ignore:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
      - '**.md'
      - 'docs/**'

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER_PROD: setof-commerce-cluster-prod
  ECS_CLUSTER_STAGE: setof-commerce-cluster-stage
  STAGE_API_URL: https://stage-server.set-of.com
  STAGE_ADMIN_URL: https://stage-partner.set-of.com

jobs:
  # ============================================================================
  # Î≥ÄÍ≤Ω Í∞êÏßÄ (Path Filter) - All Modules
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      legacy-api: ${{ steps.filter.outputs.legacy-api }}
      legacy-api-admin: ${{ steps.filter.outputs.legacy-api-admin }}
      legacy-batch: ${{ steps.filter.outputs.legacy-batch }}
      web-api: ${{ steps.filter.outputs.web-api }}
      web-api-admin: ${{ steps.filter.outputs.web-api-admin }}
      migration: ${{ steps.filter.outputs.migration }}
      shared: ${{ steps.filter.outputs.shared }}
      any-changes: ${{ steps.check.outputs.any-changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            shared:
              - 'gradle/**'
              - 'build.gradle'
              - 'settings.gradle'
              - 'libs.versions.toml'
              - 'domain/**'
              - 'application/**'
              - 'adapter-out/**'
            legacy-api:
              - 'bootstrap/bootstrap-legacy-web-api/**'
              - 'adapter-in/rest-api/**'
            legacy-api-admin:
              - 'bootstrap/bootstrap-legacy-web-api-admin/**'
              - 'adapter-in/rest-api-admin/**'
            legacy-batch:
              - 'bootstrap/bootstrap-batch/**'
            web-api:
              - 'bootstrap/bootstrap-web-api/**'
              - 'adapter-in/rest-api/**'
            web-api-admin:
              - 'bootstrap/bootstrap-web-api-admin/**'
              - 'adapter-in/rest-api-admin/**'
            migration:
              - 'bootstrap/bootstrap-migration/**'

      - name: Check if any changes
        id: check
        run: |
          if [[ "${{ steps.filter.outputs.shared }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.legacy-api }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.legacy-api-admin }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.legacy-batch }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.web-api }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.web-api-admin }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.migration }}" == "true" ]] || \
             [[ "${{ github.event.inputs.force-all }}" == "true" ]]; then
            echo "any-changes=true" >> $GITHUB_OUTPUT
          else
            echo "any-changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "### üîç Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Shared (gradle/domain/app) | ${{ steps.filter.outputs.shared }} |" >> $GITHUB_STEP_SUMMARY
          echo "| legacy-api | ${{ steps.filter.outputs.legacy-api }} |" >> $GITHUB_STEP_SUMMARY
          echo "| legacy-api-admin | ${{ steps.filter.outputs.legacy-api-admin }} |" >> $GITHUB_STEP_SUMMARY
          echo "| legacy-batch | ${{ steps.filter.outputs.legacy-batch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| web-api | ${{ steps.filter.outputs.web-api }} |" >> $GITHUB_STEP_SUMMARY
          echo "| web-api-admin | ${{ steps.filter.outputs.web-api-admin }} |" >> $GITHUB_STEP_SUMMARY
          echo "| migration | ${{ steps.filter.outputs.migration }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Force All**: ${{ github.event.inputs.force-all || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Skip Stage Check**: ${{ github.event.inputs.skip-stage-check || 'false' }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ÌÖåÏä§Ìä∏ - All Modules
  # ============================================================================
  test:
    name: Run Tests (All Modules)
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: needs.detect-changes.outputs.any-changes == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Run All Module Tests
        run: |
          chmod +x gradlew
          ./gradlew \
            :bootstrap:bootstrap-legacy-web-api:test \
            :bootstrap:bootstrap-legacy-web-api-admin:test \
            :bootstrap:bootstrap-batch:test \
            :bootstrap:bootstrap-web-api:test \
            :bootstrap:bootstrap-web-api-admin:test \
            :bootstrap:bootstrap-migration:test \
            --no-daemon

      - name: Test Summary
        if: always()
        run: |
          echo "### üß™ Test Results (All Modules)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Legacy Modules:**" >> $GITHUB_STEP_SUMMARY
          echo "- bootstrap-legacy-web-api" >> $GITHUB_STEP_SUMMARY
          echo "- bootstrap-legacy-web-api-admin" >> $GITHUB_STEP_SUMMARY
          echo "- bootstrap-batch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New Modules:**" >> $GITHUB_STEP_SUMMARY
          echo "- bootstrap-web-api" >> $GITHUB_STEP_SUMMARY
          echo "- bootstrap-web-api-admin" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Batch/Migration Modules:**" >> $GITHUB_STEP_SUMMARY
          echo "- bootstrap-batch (RunTask Ï†ÑÏö©)" >> $GITHUB_STEP_SUMMARY
          echo "- bootstrap-migration (RunTask Ï†ÑÏö©)" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ÎπåÎìú Jobs - Legacy Î™®Îìà
  # ============================================================================
  build-legacy-api:
    name: Build legacy-api
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.legacy-api == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-legacy-api-prod
      component: legacy-api
      dockerfile: bootstrap/bootstrap-legacy-web-api/Dockerfile
      gradle-task: ":bootstrap:bootstrap-legacy-web-api:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-legacy-api-admin:
    name: Build legacy-api-admin
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.legacy-api-admin == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-legacy-api-admin-prod
      component: legacy-api-admin
      dockerfile: bootstrap/bootstrap-legacy-web-api-admin/Dockerfile
      gradle-task: ":bootstrap:bootstrap-legacy-web-api-admin:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-legacy-batch:
    name: Build legacy-batch
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.legacy-batch == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-legacy-batch-prod
      component: legacy-batch
      dockerfile: bootstrap/bootstrap-batch/Dockerfile
      gradle-task: ":bootstrap:bootstrap-batch:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # ÎπåÎìú Jobs - New Î™®Îìà
  # ============================================================================
  build-web-api:
    name: Build web-api
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.web-api == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-web-api-prod
      component: web-api
      dockerfile: bootstrap/bootstrap-web-api/Dockerfile
      gradle-task: ":bootstrap:bootstrap-web-api:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-web-api-admin:
    name: Build web-api-admin
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.web-api-admin == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-web-api-admin-prod
      component: web-api-admin
      dockerfile: bootstrap/bootstrap-web-api-admin/Dockerfile
      gradle-task: ":bootstrap:bootstrap-web-api-admin:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # ÎπåÎìú Jobs - Batch/Migration Î™®Îìà (RunTask Ï†ÑÏö©)
  # ============================================================================
  build-migration:
    name: Build migration
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.migration == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-migration-prod
      component: migration
      dockerfile: bootstrap/bootstrap-migration/Dockerfile
      gradle-task: ":bootstrap:bootstrap-migration:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # NOTE: migrationÏùÄ ECS ServiceÍ∞Ä ÏóÜÏùå (RunTask Ï†ÑÏö©, legacy-batchÏôÄ ÎèôÏùº)

  # ============================================================================
  # Stage ÌôòÍ≤Ω Ìó¨Ïä§Ï≤¥ÌÅ¨ (Prod Î∞∞Ìè¨ Ï†Ñ Í≤ÄÏ¶ù)
  # ============================================================================
  verify-stage-health:
    name: Verify Stage Environment
    needs: [build-legacy-api, build-legacy-api-admin, build-legacy-batch, build-web-api, build-web-api-admin, build-migration]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # ÎπåÎìúÍ∞Ä ÌïòÎÇòÎùºÎèÑ ÏÑ±Í≥µÌïòÎ©¥ Ïã§Ìñâ, skip-stage-checkÍ∞Ä trueÎ©¥ Ïä§ÌÇµ
    if: |
      always() &&
      github.event.inputs.skip-stage-check != 'true' &&
      (needs.build-legacy-api.result == 'success' ||
       needs.build-legacy-api-admin.result == 'success' ||
       needs.build-legacy-batch.result == 'success' ||
       needs.build-web-api.result == 'success' ||
       needs.build-web-api-admin.result == 'success' ||
       needs.build-migration.result == 'success')

    steps:
      - name: Check Stage Legacy API Health
        id: stage-api
        continue-on-error: true
        run: |
          echo "üîç Checking Stage Legacy API health..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 \
            --max-time 30 \
            "${{ env.STAGE_API_URL }}/actuator/health" || echo "000")

          if [ "$RESPONSE" == "200" ]; then
            echo "‚úÖ Stage Legacy API is healthy (HTTP $RESPONSE)"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Stage Legacy API returned HTTP $RESPONSE"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi

      - name: Check Stage Admin API Health
        id: stage-admin
        continue-on-error: true
        run: |
          echo "üîç Checking Stage Admin API health..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 \
            --max-time 30 \
            "${{ env.STAGE_ADMIN_URL }}/actuator/health" || echo "000")

          if [ "$RESPONSE" == "200" ]; then
            echo "‚úÖ Stage Admin API is healthy (HTTP $RESPONSE)"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Stage Admin API returned HTTP $RESPONSE"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi

      # NOTE: web-api, web-api-admin Stage health checkÎäî ÎÇ¥Î∂Ä ÏÑúÎπÑÏä§ (Service Discovery)
      # Ïô∏Î∂Ä URLÏù¥ ÏóÜÏúºÎØÄÎ°ú Î∞∞Ìè¨ ÏÉÅÌÉúÎßå ÌôïÏù∏

      - name: Stage Health Summary
        run: |
          echo "### üè• Stage Environment Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Legacy API | ${{ steps.stage-api.outputs.status || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin API | ${{ steps.stage-admin.outputs.status || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| web-api | internal-only |" >> $GITHUB_STEP_SUMMARY
          echo "| web-api-admin | internal-only |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.stage-api.outputs.status }}" == "unhealthy" ]] || \
             [[ "${{ steps.stage-admin.outputs.status }}" == "unhealthy" ]]; then
            echo "‚ö†Ô∏è **Warning**: Stage environment has unhealthy services." >> $GITHUB_STEP_SUMMARY
            echo "Consider investigating before proceeding to Production." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ Stage environment is ready for Production deployment." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if Stage is Critical
        if: |
          steps.stage-api.outputs.status == 'unhealthy' &&
          steps.stage-admin.outputs.status == 'unhealthy'
        run: |
          echo "‚ùå Both Stage services are unhealthy. Blocking Production deployment."
          echo "Use 'skip-stage-check: true' for emergency deployments."
          exit 1

  # ============================================================================
  # Production ÏäπÏù∏ Í≤åÏù¥Ìä∏
  # GitHub Repository Settings ‚Üí Environments ‚Üí production ÏóêÏÑú ÏÑ§Ï†ï:
  # - Required reviewers Ï∂îÍ∞Ä
  # - Wait timer ÏÑ§Ï†ï (ÏÑ†ÌÉù)
  # ============================================================================
  approve-production:
    name: Approve Production Deployment
    needs: [build-legacy-api, build-legacy-api-admin, build-legacy-batch, build-web-api, build-web-api-admin, build-migration, verify-stage-health]
    runs-on: ubuntu-latest
    environment: production
    if: |
      always() &&
      (needs.build-legacy-api.result == 'success' ||
       needs.build-legacy-api-admin.result == 'success' ||
       needs.build-legacy-batch.result == 'success' ||
       needs.build-web-api.result == 'success' ||
       needs.build-web-api-admin.result == 'success' ||
       needs.build-migration.result == 'success') &&
      (needs.verify-stage-health.result == 'success' ||
       needs.verify-stage-health.result == 'skipped' ||
       github.event.inputs.skip-stage-check == 'true')

    steps:
      - name: Production Deployment Approved
        run: |
          echo "### ‚úÖ Production Deployment Approved" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Approved by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Proceeding with Production deployment..." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Î∞∞Ìè¨ Jobs - Legacy Î™®Îìà (ÏäπÏù∏ ÌõÑ Ïã§Ìñâ)
  # ============================================================================
  deploy-legacy-api:
    name: Deploy legacy-api
    needs: [build-legacy-api, approve-production]
    if: |
      needs.build-legacy-api.result == 'success' &&
      needs.approve-production.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-legacy-api-prod
      image-uri: ${{ needs.build-legacy-api.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-legacy-api-admin:
    name: Deploy legacy-api-admin
    needs: [build-legacy-api-admin, approve-production]
    if: |
      needs.build-legacy-api-admin.result == 'success' &&
      needs.approve-production.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-legacy-admin-prod
      image-uri: ${{ needs.build-legacy-api-admin.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # NOTE: legacy-batchÎäî ECS ServiceÍ∞Ä ÏóÜÏùå (RunTask Ï†ÑÏö©)
  # EventBridge Ïä§ÏºÄÏ§ÑÏù¥ ÏûêÎèôÏúºÎ°ú ÏµúÏã† Task Definition ÏÇ¨Ïö©

  # ============================================================================
  # Î∞∞Ìè¨ Jobs - New Î™®Îìà (ÏäπÏù∏ ÌõÑ Ïã§Ìñâ)
  # ============================================================================
  deploy-web-api:
    name: Deploy web-api
    needs: [build-web-api, approve-production]
    if: |
      needs.build-web-api.result == 'success' &&
      needs.approve-production.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-web-api-prod
      image-uri: ${{ needs.build-web-api.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-web-api-admin:
    name: Deploy web-api-admin
    needs: [build-web-api-admin, approve-production]
    if: |
      needs.build-web-api-admin.result == 'success' &&
      needs.approve-production.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-web-api-admin-prod
      image-uri: ${{ needs.build-web-api-admin.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # Terraform Image Tag ÏóÖÎç∞Ïù¥Ìä∏ (ÏäπÏù∏ ÌõÑ Ïã§Ìñâ)
  # ============================================================================
  update-terraform-tags:
    name: Update Terraform Image Tags
    needs: [build-legacy-api, build-legacy-api-admin, build-legacy-batch, build-web-api, build-web-api-admin, build-migration, approve-production]
    if: |
      always() &&
      needs.approve-production.result == 'success' &&
      (needs.build-legacy-api.result == 'success' ||
       needs.build-legacy-api-admin.result == 'success' ||
       needs.build-legacy-batch.result == 'success' ||
       needs.build-web-api.result == 'success' ||
       needs.build-web-api-admin.result == 'success' ||
       needs.build-migration.result == 'success')
    uses: ./.github/workflows/terraform-apply.yml
    with:
      legacy-api-image-tag: ${{ needs.build-legacy-api.outputs.image-tag || '' }}
      legacy-api-admin-image-tag: ${{ needs.build-legacy-api-admin.outputs.image-tag || '' }}
      legacy-batch-image-tag: ${{ needs.build-legacy-batch.outputs.image-tag || '' }}
      # NOTE: web-api, web-api-admin, migration Prod Terraform Î™®Îìà Ï∂îÍ∞Ä Ïãú ÏïÑÎûò Ï£ºÏÑù Ìï¥Ï†ú
      # web-api-image-tag: ${{ needs.build-web-api.outputs.image-tag || '' }}
      # web-api-admin-image-tag: ${{ needs.build-web-api-admin.outputs.image-tag || '' }}
      # migration-image-tag: ${{ needs.build-migration.outputs.image-tag || '' }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # Production Ìó¨Ïä§Ï≤¥ÌÅ¨ (Î∞∞Ìè¨ ÌõÑ Í≤ÄÏ¶ù)
  # ============================================================================
  verify-production-health:
    name: Verify Production Deployment
    needs: [deploy-legacy-api, deploy-legacy-api-admin, deploy-web-api, deploy-web-api-admin, update-terraform-tags]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      always() &&
      (needs.deploy-legacy-api.result == 'success' ||
       needs.deploy-legacy-api-admin.result == 'success' ||
       needs.deploy-web-api.result == 'success' ||
       needs.deploy-web-api-admin.result == 'success')

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-2
          role-duration-seconds: 900

      - name: Wait for ECS deployment stabilization
        run: |
          echo "‚è≥ Waiting 60 seconds for ECS deployment to stabilize..."
          sleep 60

      - name: Check Production Legacy API Health
        id: prod-api
        continue-on-error: true
        run: |
          echo "üîç Checking Production Legacy API health..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 \
            --max-time 30 \
            "https://server.set-of.com/actuator/health" || echo "000")

          if [ "$RESPONSE" == "200" ]; then
            echo "‚úÖ Production Legacy API is healthy (HTTP $RESPONSE)"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Production Legacy API returned HTTP $RESPONSE"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi

      - name: Check Production Admin API Health
        id: prod-admin
        continue-on-error: true
        run: |
          echo "üîç Checking Production Admin API health..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 \
            --max-time 30 \
            "https://partner.set-of.com/actuator/health" || echo "000")

          if [ "$RESPONSE" == "200" ]; then
            echo "‚úÖ Production Admin API is healthy (HTTP $RESPONSE)"
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Production Admin API returned HTTP $RESPONSE"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi

      # NOTE: web-api, web-api-admin Production health checkÎäî ÎÇ¥Î∂Ä ÏÑúÎπÑÏä§ (Service Discovery)
      # Ïô∏Î∂Ä URLÏù¥ ÏóÜÏúºÎØÄÎ°ú Î∞∞Ìè¨ ÏÉÅÌÉúÎßå ÌôïÏù∏

      - name: Production Health Summary
        run: |
          echo "### üè• Production Health Check (Post-Deployment)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Legacy API | ${{ steps.prod-api.outputs.status || 'not-deployed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin API | ${{ steps.prod-admin.outputs.status || 'not-deployed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| web-api | internal-only |" >> $GITHUB_STEP_SUMMARY
          echo "| web-api-admin | internal-only |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Î∞∞Ìè¨ ÏôÑÎ£å ÏïåÎ¶º
  # ============================================================================
  notify:
    name: Deployment Notification
    needs: [detect-changes, test, build-migration, approve-production, deploy-legacy-api, deploy-legacy-api-admin, deploy-web-api, deploy-web-api-admin, update-terraform-tags, verify-production-health]
    if: always()
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-notify-slack.yml@main
    with:
      project-name: SetOf Commerce
      environment: prod
      status: |
        ${{
          (needs.test.result == 'failure') && 'failure' ||
          (needs.approve-production.result == 'failure') && 'cancelled' ||
          (needs.deploy-legacy-api.result == 'success' || needs.deploy-legacy-api.result == 'skipped') &&
          (needs.deploy-legacy-api-admin.result == 'success' || needs.deploy-legacy-api-admin.result == 'skipped') &&
          (needs.deploy-web-api.result == 'success' || needs.deploy-web-api.result == 'skipped') &&
          (needs.deploy-web-api-admin.result == 'success' || needs.deploy-web-api-admin.result == 'skipped') &&
          'success' || 'failure'
        }}
      components: |
        [
          {"name": "test", "status": "${{ needs.test.result }}"},
          {"name": "stage-check", "status": "${{ needs.verify-stage-health.result || 'skipped' }}"},
          {"name": "approval", "status": "${{ needs.approve-production.result }}"},
          {"name": "legacy-api", "status": "${{ needs.deploy-legacy-api.result }}"},
          {"name": "legacy-api-admin", "status": "${{ needs.deploy-legacy-api-admin.result }}"},
          {"name": "migration (build)", "status": "${{ needs.build-migration.result }}"},
          {"name": "web-api", "status": "${{ needs.deploy-web-api.result }}"},
          {"name": "web-api-admin", "status": "${{ needs.deploy-web-api-admin.result }}"},
          {"name": "terraform-tags", "status": "${{ needs.update-terraform-tags.result }}"},
          {"name": "prod-health", "status": "${{ needs.verify-production-health.result }}"}
        ]
      mention-on-failure: "@here"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
