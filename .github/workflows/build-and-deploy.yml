# ============================================================================
# SetOf Commerce Build & Deploy (Legacy Only)
#
# í˜„ì¬ ë°°í¬ ëŒ€ìƒ:
# - legacy-api (bootstrap-legacy-web-api)
# - legacy-api-admin (bootstrap-legacy-web-api-admin)
# - legacy-batch (bootstrap-batch)
#
# TODO: ì¶”í›„ ì•ˆì •í™” í›„ ì¶”ê°€ ì˜ˆì •
# - web-api, web-api-admin, migration
# ============================================================================

name: Build and Deploy to ECS

on:
  workflow_dispatch:
    inputs:
      force-all:
        description: 'ëª¨ë“  ì„œë¹„ìŠ¤ ê°•ì œ ë¹Œë“œ/ë°°í¬'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths-ignore:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
      - '**.md'
      - 'docs/**'

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: setof-commerce-cluster-prod

jobs:
  # ============================================================================
  # ë³€ê²½ ê°ì§€ (Path Filter) - Legacy ëª¨ë“ˆë§Œ
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      legacy-api: ${{ steps.filter.outputs.legacy-api }}
      legacy-api-admin: ${{ steps.filter.outputs.legacy-api-admin }}
      legacy-batch: ${{ steps.filter.outputs.legacy-batch }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            shared:
              - 'gradle/**'
              - 'build.gradle'
              - 'settings.gradle'
              - 'libs.versions.toml'
            legacy-api:
              - 'bootstrap/bootstrap-legacy-web-api/**'
            legacy-api-admin:
              - 'bootstrap/bootstrap-legacy-web-api-admin/**'
            legacy-batch:
              - 'bootstrap/bootstrap-batch/**'

      - name: Summary
        run: |
          echo "### ğŸ” Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Shared (gradle) | ${{ steps.filter.outputs.shared }} |" >> $GITHUB_STEP_SUMMARY
          echo "| legacy-api | ${{ steps.filter.outputs.legacy-api }} |" >> $GITHUB_STEP_SUMMARY
          echo "| legacy-api-admin | ${{ steps.filter.outputs.legacy-api-admin }} |" >> $GITHUB_STEP_SUMMARY
          echo "| legacy-batch | ${{ steps.filter.outputs.legacy-batch }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # í…ŒìŠ¤íŠ¸ - Legacy ëª¨ë“ˆë§Œ (ArchUnit, domain í…ŒìŠ¤íŠ¸ ì œì™¸)
  # ============================================================================
  test:
    name: Run Tests (Legacy Only)
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: |
      needs.detect-changes.outputs.shared == 'true' ||
      needs.detect-changes.outputs.legacy-api == 'true' ||
      needs.detect-changes.outputs.legacy-api-admin == 'true' ||
      needs.detect-changes.outputs.legacy-batch == 'true' ||
      github.event.inputs.force-all == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Run Legacy Module Tests Only
        run: |
          chmod +x gradlew
          ./gradlew \
            :bootstrap:bootstrap-legacy-web-api:test \
            :bootstrap:bootstrap-legacy-web-api-admin:test \
            :bootstrap:bootstrap-batch:test \
            --no-daemon

      - name: Test Summary
        if: always()
        run: |
          echo "### ğŸ§ª Test Results (Legacy Modules)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- bootstrap-legacy-web-api" >> $GITHUB_STEP_SUMMARY
          echo "- bootstrap-legacy-web-api-admin" >> $GITHUB_STEP_SUMMARY
          echo "- bootstrap-batch" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ë¹Œë“œ Jobs - Legacy ëª¨ë“ˆë§Œ
  # ============================================================================
  build-legacy-api:
    name: Build legacy-api
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.legacy-api == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-legacy-api-prod
      component: legacy-api
      dockerfile: bootstrap/bootstrap-legacy-web-api/Dockerfile
      gradle-task: ":bootstrap:bootstrap-legacy-web-api:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-legacy-api-admin:
    name: Build legacy-api-admin
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.legacy-api-admin == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-legacy-api-admin-prod
      component: legacy-api-admin
      dockerfile: bootstrap/bootstrap-legacy-web-api-admin/Dockerfile
      gradle-task: ":bootstrap:bootstrap-legacy-web-api-admin:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-legacy-batch:
    name: Build legacy-batch
    needs: [detect-changes, test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.detect-changes.outputs.shared == 'true' ||
       needs.detect-changes.outputs.legacy-batch == 'true' ||
       github.event.inputs.force-all == 'true')
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-legacy-batch-prod
      component: legacy-batch
      dockerfile: bootstrap/bootstrap-batch/Dockerfile
      gradle-task: ":bootstrap:bootstrap-batch:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # ë°°í¬ Jobs - Legacy ëª¨ë“ˆë§Œ
  # ============================================================================
  deploy-legacy-api:
    name: Deploy legacy-api
    needs: build-legacy-api
    if: needs.build-legacy-api.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-legacy-api-prod
      image-uri: ${{ needs.build-legacy-api.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-legacy-api-admin:
    name: Deploy legacy-api-admin
    needs: build-legacy-api-admin
    if: needs.build-legacy-api-admin.result == 'success'
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-legacy-admin-prod
      image-uri: ${{ needs.build-legacy-api-admin.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # NOTE: legacy-batchëŠ” ECS Serviceê°€ ì—†ìŒ (RunTask ì „ìš©)
  # EventBridge ìŠ¤ì¼€ì¤„ì´ ìë™ìœ¼ë¡œ ìµœì‹  Task Definition ì‚¬ìš©

  # ============================================================================
  # Terraform Image Tag ì—…ë°ì´íŠ¸
  # ============================================================================
  update-terraform-tags:
    name: Update Terraform Image Tags
    needs: [build-legacy-api, build-legacy-api-admin, build-legacy-batch]
    if: |
      always() &&
      (needs.build-legacy-api.result == 'success' ||
       needs.build-legacy-api-admin.result == 'success' ||
       needs.build-legacy-batch.result == 'success')
    uses: ./.github/workflows/terraform-apply.yml
    with:
      legacy-api-image-tag: ${{ needs.build-legacy-api.outputs.image-tag || '' }}
      legacy-api-admin-image-tag: ${{ needs.build-legacy-api-admin.outputs.image-tag || '' }}
      legacy-batch-image-tag: ${{ needs.build-legacy-batch.outputs.image-tag || '' }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  # ============================================================================
  notify:
    name: Deployment Notification
    needs: [detect-changes, test, deploy-legacy-api, deploy-legacy-api-admin, update-terraform-tags]
    if: always()
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-notify-slack.yml@main
    with:
      project-name: SetOf Commerce (Legacy)
      environment: prod
      status: |
        ${{
          (needs.test.result == 'failure') && 'failure' ||
          (needs.deploy-legacy-api.result == 'success' || needs.deploy-legacy-api.result == 'skipped') &&
          (needs.deploy-legacy-api-admin.result == 'success' || needs.deploy-legacy-api-admin.result == 'skipped') &&
          'success' || 'failure'
        }}
      components: |
        [
          {"name": "test", "status": "${{ needs.test.result }}"},
          {"name": "legacy-api", "status": "${{ needs.deploy-legacy-api.result }}"},
          {"name": "legacy-api-admin", "status": "${{ needs.deploy-legacy-api-admin.result }}"},
          {"name": "terraform-tags", "status": "${{ needs.update-terraform-tags.result }}"}
        ]
      mention-on-failure: "@here"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
