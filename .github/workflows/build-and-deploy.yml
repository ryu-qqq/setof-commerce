# ============================================================================
# SetOf Commerce Build & Deploy
#
# Reusable Workflows 사용하여 단순화
# web-api, web-api-admin, legacy-api, legacy-api-admin, migration 빌드/배포
# ============================================================================

name: Build and Deploy to ECS

on:
  workflow_dispatch:  # 수동 트리거 허용
  push:
    branches:
      - main
    paths-ignore:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
      - '**.md'
      - 'docs/**'

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: setof-commerce-cluster-prod

jobs:
  # ============================================================================
  # 테스트 (공통 - 한 번만 실행)
  # FIXME: 테스트 수정 후 continue-on-error 제거 필요
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Run tests
        run: |
          chmod +x gradlew
          ./gradlew clean test -x jacocoTestCoverageVerification --no-daemon
        continue-on-error: true

  # ============================================================================
  # 빌드 Jobs
  # ============================================================================
  build-web-api:
    name: Build web-api
    needs: test
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-web-api-prod
      component: web-api
      dockerfile: bootstrap/bootstrap-web-api/Dockerfile
      gradle-task: ":bootstrap:bootstrap-web-api:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-web-api-admin:
    name: Build web-api-admin
    needs: test
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-web-api-admin-prod
      component: web-api-admin
      dockerfile: bootstrap/bootstrap-web-api-admin/Dockerfile
      gradle-task: ":bootstrap:bootstrap-web-api-admin:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-legacy-api:
    name: Build legacy-api
    needs: test
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-legacy-api-prod
      component: legacy-api
      dockerfile: bootstrap/bootstrap-legacy-web-api/Dockerfile
      gradle-task: ":bootstrap:bootstrap-legacy-web-api:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-legacy-api-admin:
    name: Build legacy-api-admin
    needs: test
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-legacy-api-admin-prod
      component: legacy-api-admin
      dockerfile: bootstrap/bootstrap-legacy-web-api-admin/Dockerfile
      gradle-task: ":bootstrap:bootstrap-legacy-web-api-admin:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  build-migration:
    name: Build migration
    needs: test
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: setof-commerce-migration-prod
      component: migration
      dockerfile: bootstrap/bootstrap-migration/Dockerfile
      gradle-task: ":bootstrap:bootstrap-migration:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # 배포 Jobs
  # ============================================================================
  deploy-web-api:
    name: Deploy web-api
    needs: build-web-api
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-web-api-prod
      image-uri: ${{ needs.build-web-api.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-web-api-admin:
    name: Deploy web-api-admin
    needs: build-web-api-admin
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-web-api-admin-prod
      image-uri: ${{ needs.build-web-api-admin.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-legacy-api:
    name: Deploy legacy-api
    needs: build-legacy-api
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-legacy-api-prod
      image-uri: ${{ needs.build-legacy-api.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-legacy-api-admin:
    name: Deploy legacy-api-admin
    needs: build-legacy-api-admin
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-legacy-api-admin-prod
      image-uri: ${{ needs.build-legacy-api-admin.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  deploy-migration:
    name: Deploy migration
    needs: build-migration
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: setof-commerce-cluster-prod
      ecs-service: setof-commerce-migration-prod
      image-uri: ${{ needs.build-migration.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # Terraform Image Tag 업데이트 (자동화)
  # ============================================================================
  update-terraform-tags:
    name: Update Terraform Image Tags
    needs: [build-web-api, build-web-api-admin, build-legacy-api, build-legacy-api-admin, build-migration]
    uses: ./.github/workflows/terraform-apply.yml
    with:
      web-api-image-tag: ${{ needs.build-web-api.outputs.image-tag }}
      web-api-admin-image-tag: ${{ needs.build-web-api-admin.outputs.image-tag }}
      legacy-api-image-tag: ${{ needs.build-legacy-api.outputs.image-tag }}
      legacy-api-admin-image-tag: ${{ needs.build-legacy-api-admin.outputs.image-tag }}
      migration-image-tag: ${{ needs.build-migration.outputs.image-tag }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # 배포 완료 알림 (Slack + GitHub Summary)
  # ============================================================================
  notify:
    name: Deployment Notification
    needs: [deploy-web-api, deploy-web-api-admin, deploy-legacy-api, deploy-legacy-api-admin, deploy-migration, update-terraform-tags]
    if: always()
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-notify-slack.yml@main
    with:
      project-name: SetOf Commerce
      environment: prod
      status: ${{ (needs.deploy-web-api.result == 'success' && needs.deploy-web-api-admin.result == 'success' && needs.deploy-legacy-api.result == 'success' && needs.deploy-legacy-api-admin.result == 'success' && needs.deploy-migration.result == 'success' && needs.update-terraform-tags.result == 'success') && 'success' || 'failure' }}
      components: |
        [
          {"name": "web-api", "status": "${{ needs.deploy-web-api.result }}"},
          {"name": "web-api-admin", "status": "${{ needs.deploy-web-api-admin.result }}"},
          {"name": "legacy-api", "status": "${{ needs.deploy-legacy-api.result }}"},
          {"name": "legacy-api-admin", "status": "${{ needs.deploy-legacy-api-admin.result }}"},
          {"name": "migration", "status": "${{ needs.deploy-migration.result }}"},
          {"name": "terraform-tags", "status": "${{ needs.update-terraform-tags.result }}"}
        ]
      mention-on-failure: "@here"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
